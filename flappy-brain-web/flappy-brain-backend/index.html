<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Brain - taqanthan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax cho c√¥ng th·ª©c to√°n -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <style>
        /* T√πy ch·ªânh font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            user-select: none;
            /* ƒê·∫¢M B·∫¢O C√ì THANH CU·ªòN D·ªåC */
            overflow-y: auto;
            min-height: 100vh;
        }
        
        /* MENU STYLES - FIXED POSITION */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 2000;
            animation: menuFadeIn 0.5s ease-out;
            /* QUAN TR·ªåNG: TH√äM OVERFLY-Y AUTO ƒê·ªÇ CU·ªòN */
            overflow-y: auto;
            overflow-x: hidden;
        }

        .menu-container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* TH√äM MARGIN BOTTOM ƒê·ªÇ C√ì KH√îNG GIAN CU·ªòN */
            margin-bottom: 40px;
        }

        @keyframes menuFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .menu-title {
            font-size: 4rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            margin-bottom: 1rem;
            animation: titleBounce 2s ease-in-out infinite;
            text-align: center;
            margin-top: 40px; /* TƒÇNG MARGIN TOP */
        }

        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .menu-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 280px;
            margin-bottom: 3rem; /* TƒÇNG MARGIN BOTTOM */
        }

        .menu-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .menu-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .menu-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .menu-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .menu-button:active {
            transform: translateY(-2px) scale(1.02);
        }

        .menu-button.secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #764ba2;
        }

        .menu-button.info {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #764ba2;
        }

        .menu-button span {
            position: relative;
            z-index: 1;
        }

        /* ========== THI·∫æT K·∫æ M·ªöI CHO PH·∫¶N CH·ªåN L·ªöP/M√îN ========== */
        .selection-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .selection-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .selection-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .selection-title {
            color: white;
            font-weight: 700;
            font-size: 1.3rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Grade selection grid - THI·∫æT K·∫æ M·ªöI */
        .grade-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .grade-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
        }

        .grade-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .grade-item.active {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            border-color: #22c55e;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .grade-number {
            font-size: 1.8rem;
            font-weight: 900;
            color: white;
            margin-bottom: 0.2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .grade-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
        }

        /* Subject selection - THI·∫æT K·∫æ M·ªöI */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.8rem;
        }

        .subject-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 0.8rem 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
        }

        .subject-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .subject-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #764ba2;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .subject-icon {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }

        .subject-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Selected info display - THI·∫æT K·∫æ M·ªöI */
        .selected-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .selected-text {
            color: white;
            font-size: 1rem;
            font-weight: 700;
        }

        .selected-value {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 0.5rem 1.2rem;
            border-radius: 25px;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* ========== NEW FEATURES STYLES ========== */

        /* Explanation Modal Styles */
        .explanation-modal-content {
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(102, 126, 234, 0.3);
            animation: modalSlideUp 0.4s ease-out;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .explanation-text {
            color: #333;
            line-height: 1.6;
            font-size: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }

        .explanation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .explanation-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .explanation-button.continue {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .explanation-button.close {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .explanation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Continue Button in Question Modal */
        .continue-button-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .continue-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .continue-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .explanation-button-small {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .explanation-button-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        /* Assessment Styles */
        .assessment-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .assessment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .assessment-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: #667eea;
        }

        .assessment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .assessment-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .assessment-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .assessment-value {
            font-size: 1.8rem;
            font-weight: 900;
        }

        .assessment-grade {
            font-size: 1rem;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Subject Progress Bars */
        .subject-progress {
            margin-top: 15px;
        }

        .subject-item-progress {
            margin-bottom: 10px;
        }

        .subject-name {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .subject-percentage {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .progress-bar-container {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Score Colors */
        .score-excellent { color: #10b981; }
        .score-good { color: #3b82f6; }
        .score-average { color: #f59e0b; }
        .score-need-improvement { color: #ef4444; }

        .bg-score-excellent { background: #10b981; }
        .bg-score-good { background: #3b82f6; }
        .bg-score-average { background: #f59e0b; }
        .bg-score-need-improvement { background: #ef4444; }

        /* Auto Continue Indicator */
        .auto-continue-indicator {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            animation: pulse 2s infinite;
            backdrop-filter: blur(5px);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Loading for AI Explanation */
        .explanation-loading {
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Updated Question Modal */
        .modal-content-enhanced {
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            width: 95%;
            max-width: 350px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        /* SETTINGS MODAL - M·ªöI */
        #settingsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3001;
        }

        .settings-modal-content {
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(102, 126, 234, 0.3);
            animation: modalSlideUp 0.4s ease-out;
        }

        .settings-title {
            font-size: 2rem;
            font-weight: 900;
            color: #764ba2;
            margin-bottom: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 0.5rem;
            display: block;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 1rem;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .color-option.active {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.3);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #764ba2;
        }

        input[type="range"] {
            flex-grow: 1;
            height: 8px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #764ba2;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            margin-top: -8px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #764ba2;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .language-buttons {
            display: flex;
            gap: 10px;
        }

        .lang-button {
            flex: 1;
            padding: 0.8rem;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            background: rgba(118, 75, 162, 0.2);
            border: 2px solid rgba(118, 75, 162, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .lang-button:hover {
            background: rgba(118, 75, 162, 0.3);
        }

        .lang-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #764ba2;
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            margin-top: 2rem;
        }

        .settings-button {
            flex: 1;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .settings-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .settings-button.reset {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* Floating particles effect */
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Info Modal */
        #infoModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .info-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.4s ease-out;
            color: #333;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .info-content h2 {
            color: #764ba2;
            font-size: 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .info-content h3 {
            color: #667eea;
            font-size: 1.3rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .info-content p, .info-content ul {
            color: #4a5568;
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .info-content ul {
            padding-left: 1.5rem;
        }

        .info-content li {
            margin-bottom: 0.5rem;
        }

        .close-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1.5rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .game-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100vw;
            padding: 0;
        }

        #gameCanvas {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            display: block;
            background-color: #70c5ce;
            image-rendering: pixelated;
        }

        /* Hi·ªáu ·ª©ng ƒëi·ªÉm th∆∞·ªüng */
        .score-plus-effect {
            position: absolute;
            font-size: 3rem;
            color: #4ade80;
            font-weight: 900;
            opacity: 0;
            animation: scorePop 1.5s ease-out forwards;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes scorePop {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* Loading overlay */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Modal cho C√¢u h·ªèi */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* Progress bar for stats */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background-color: #e5e7eb;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .answer-button {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 0.9rem;
            border: 1px solid transparent;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: left;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .answer-button:hover {
            transform: scale(1.02); 
            box-shadow: 0 4px 8px rgba(67, 56, 202, 0.3); 
        }
        .answer-button.disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            text-decoration: line-through;
            opacity: 0.7;
            box-shadow: none;
        }
        
        #jumpButton {
            width: 56px;
            height: 56px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #menuButtonInGame {
            width: 56px;
            height: 56px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Win Modal */
        #winModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }

        .win-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 20px;
            max-width: 350px;
            width: 85%;
            text-align: center;
            color: white;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            animation: winSlideIn 0.6s ease-out;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes winSlideIn {
            from { transform: translateY(-80px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .win-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            color: #FFD700;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        }

        .win-message {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }

        .win-stats {
            background: rgba(255, 255, 255, 0.12);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .win-button {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 0.9rem 1.2rem;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 0.7rem;
            font-size: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .win-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
        }

        .win-button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.6rem;
            font-size: 1rem;
        }

        .stat-value {
            font-weight: 700;
            color: #FFD700;
        }

        /* Pause overlay */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 12px;
            gap: 20px;
        }

        .pause-text {
            color: white;
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .pause-button {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* Confetti effect */
        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            opacity: 0;
            animation: confettiFall 2s ease-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(360deg); opacity: 0; }
        }

        /* SCROLLABLE AREA TRONG SETTINGS MODAL */
        .scrollable-content {
            width: 100%;
            max-height: 55vh;
            overflow-y: auto;
            padding-right: 10px;
            margin-top: 1rem;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        /* Auth styles */
        .auth-form {
            animation: fadeIn 0.3s ease-out;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .tab-button {
            transition: all 0.3s ease;
            color: #ffffff;
        }

        .tab-button.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
        }

        .tab-button:not(.active):hover {
            color: #cbd5e1;
        }

        .user-dropdown-enter {
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* T√†i kho·∫£n tr√™n menu */
        .user-account-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 2500;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .menu-title {
                font-size: 3rem;
            }
            
            .color-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .settings-title {
                font-size: 1.8rem;
            }
            
            /* RESPONSIVE CHO PH·∫¶N CH·ªåN M·ªöI */
            .grade-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .selection-panel {
                padding: 1rem;
            }
            
            /* Responsive for new features */
            .explanation-modal-content {
                width: 95%;
                padding: 15px;
            }
            
            .assessment-grid {
                grid-template-columns: 1fr;
            }
            
            .explanation-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .menu-title {
                font-size: 2.5rem;
            }
            
            .menu-subtitle {
                font-size: 1rem;
            }
            
            .menu-button {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            
            .color-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* RESPONSIVE CHO PH·∫¶N CH·ªåN M·ªöI */
            .grade-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.6rem;
            }
            
            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grade-number {
                font-size: 1.5rem;
            }
            
            .selection-panel {
                padding: 0.8rem;
                margin-bottom: 1rem;
            }
        }
        
        /* Thanh cu·ªôn t√πy ch·ªânh cho to√†n b·ªô trang */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* QUAN TR·ªåNG: ƒê·∫¢M B·∫¢O HTML C≈®NG C√ì THANH CU·ªòN */
        html {
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* L·ªúI KHEN KHI TR·∫¢ L·ªúI ƒê√öNG - ƒê√É S·ª¨A: TƒÇNG TH·ªúI GIAN HI·ªÇN TH·ªä */
        .praise-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            z-index: 9999;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: praiseSlideIn 0.5s ease-out, praiseFadeOut 0.5s ease-out 2.5s forwards; /* THAY ƒê·ªîI: 2.5s thay v√¨ 1.5s */
            transform: translateX(120%);
            max-width: 300px;
            text-align: center;
        }
        
        @keyframes praiseSlideIn {
            0% { transform: translateX(120%); }
            70% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes praiseFadeOut {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(120%); }
        }
        
        .praise-notification::before {
            content: 'üéâ';
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        /* Settings panel c≈© (gi·ªØ l·∫°i nh∆∞ng ·∫©n ƒëi) */
        #settingsPanel {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-800 text-white">

    <!-- AUTH MODALS -->
    <!-- LOGIN/REGISTER MODAL -->
    <div id="authModal" class="modal" style="display: flex;">
        <div class="modal-content" style="max-width: 400px; background: rgba(30, 30, 40, 0.95); border: 2px solid rgba(255, 255, 255, 0.1);">
            <div id="authTabs" class="flex mb-4 border-b border-gray-600">
                <button id="loginTab" class="tab-button active flex-1 py-2 font-bold text-purple-400 border-b-2 border-purple-400" onclick="switchAuthTab('login')">
                    <span id="loginTabText">ƒêƒÇNG NH·∫¨P</span>
                </button>
                <button id="registerTab" class="tab-button flex-1 py-2 font-bold text-gray-300" onclick="switchAuthTab('register')">
                    <span id="registerTabText">ƒêƒÇNG K√ù</span>
                </button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <div class="mb-4">
                    <label class="block text-gray-200 text-sm font-bold mb-2" for="loginUsername" id="loginUsernameLabel">
                        T√™n ƒëƒÉng nh·∫≠p:
                    </label>
                    <input type="text" id="loginUsername" class="w-full px-3 py-2 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 bg-gray-800 text-white" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-200 text-sm font-bold mb-2" for="loginPassword" id="loginPasswordLabel">
                        M·∫≠t kh·∫©u:
                    </label>
                    <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 bg-gray-800 text-white" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                </div>
                <div id="loginMessage" class="mb-4 text-sm text-center"></div>
                <button onclick="handleLogin()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200" id="loginButton">
                    ƒêƒÇNG NH·∫¨P
                </button>
                <p class="text-center text-sm text-gray-300 mt-4" id="switchToRegisterText">
                    Ch∆∞a c√≥ t√†i kho·∫£n? <a href="javascript:void(0)" onclick="switchAuthTab('register')" class="text-purple-400 font-bold">ƒêƒÉng k√Ω ngay</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form" style="display: none;">
                <div class="mb-4">
                    <label class="block text-gray-200 text-sm font-bold mb-2" for="registerUsername" id="registerUsernameLabel">
                        T√™n ƒëƒÉng nh·∫≠p*:
                    </label>
                    <input type="text" id="registerUsername" class="w-full px-3 py-2 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 bg-gray-800 text-white" placeholder="T·ª´ 3-20 k√Ω t·ª±">
                    <p class="text-xs text-gray-400 mt-1" id="usernameHelpText">M·ªói t√™n ƒëƒÉng nh·∫≠p ch·ªâ ƒë∆∞·ª£c d√πng m·ªôt l·∫ßn</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-200 text-sm font-bold mb-2" for="registerPassword" id="registerPasswordLabel">
                        M·∫≠t kh·∫©u*:
                    </label>
                    <input type="password" id="registerPassword" class="w-full px-3 py-2 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 bg-gray-800 text-white" placeholder="√çt nh·∫•t 6 k√Ω t·ª±">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-200 text-sm font-bold mb-2" for="confirmPassword" id="confirmPasswordLabel">
                        X√°c nh·∫≠n m·∫≠t kh·∫©u*:
                    </label>
                    <input type="password" id="confirmPassword" class="w-full px-3 py-2 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 bg-gray-800 text-white" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-200 text-sm font-bold mb-2" for="birthDate" id="birthDateLabel">
                        Ng√†y sinh*:
                    </label>
                    <input type="date" id="birthDate" class="w-full px-3 py-2 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 bg-gray-800 text-white">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-200 text-sm font-bold mb-2" id="genderLabel">
                        Gi·ªõi t√≠nh*:
                    </label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="male" class="text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-white" id="genderMaleText">Nam</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="female" class="text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-white" id="genderFemaleText">N·ªØ</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="other" class="text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-white" id="genderOtherText">Kh√°c</span>
                        </label>
                    </div>
                </div>
                <div id="registerMessage" class="mb-4 text-sm text-center"></div>
                <button onclick="handleRegister()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200" id="registerButton">
                    ƒêƒÇNG K√ù T√ÄI KHO·∫¢N
                </button>
                <p class="text-center text-sm text-gray-300 mt-4" id="switchToLoginText">
                    ƒê√£ c√≥ t√†i kho·∫£n? <a href="javascript:void(0)" onclick="switchAuthTab('login')" class="text-purple-400 font-bold">ƒêƒÉng nh·∫≠p</a>
                </p>
            </div>
        </div>
    </div>

    <!-- USER PROFILE MENU -->
    <div id="userMenu" style="display: none;" class="fixed top-4 left-4 z-50">
        <div class="flex items-center space-x-2">
            <div class="relative">
                <button id="userAvatarButton" onclick="toggleUserDropdown()" class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold shadow-lg hover:shadow-xl transition">
                    <span id="avatarText">U</span>
                </button>
                <div id="userDropdown" class="absolute left-0 mt-2 w-48 bg-gray-900 rounded-lg shadow-xl py-2 hidden border border-gray-700">
                    <div class="px-4 py-2 border-b border-gray-700">
                        <p class="font-bold text-white" id="dropdownUsername">Username</p>
                        <p class="text-xs text-gray-400" id="dropdownStatus">ƒêang ch∆°i</p>
                    </div>
                    <a href="javascript:void(0)" onclick="showProfile()" class="block px-4 py-2 text-gray-300 hover:bg-indigo-900 hover:text-white transition flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span id="profileText">H·ªì s∆°</span>
                    </a>
                    <a href="javascript:void(0)" onclick="showStats()" class="block px-4 py-2 text-gray-300 hover:bg-indigo-900 hover:text-white transition flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span id="statsText">Th·ªëng k√™</span>
                    </a>
                    <a href="javascript:void(0)" onclick="logout()" class="block px-4 py-2 text-gray-300 hover:bg-red-900 hover:text-white transition flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span id="logoutText">ƒêƒÉng xu·∫•t</span>
                    </a>
                </div>
            </div>
            <div class="text-white">
                <p class="font-bold text-sm" id="usernameDisplay">Kh√°ch</p>
                <p class="text-xs opacity-75" id="scoreDisplay">ƒêi·ªÉm cao: 0</p>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profileModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2 class="text-xl font-bold mb-4 text-center text-indigo-700" id="profileTitle">H·ªí S∆† NG∆Ø·ªúI D√ôNG</h2>
            
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg mb-4">
                <div class="flex items-center mb-4">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white flex items-center justify-center text-2xl font-bold mr-4 shadow-lg">
                        <span id="profileAvatar">U</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-gray-800" id="profileUsername">Username</h3>
                        <p class="text-sm text-gray-600" id="profileJoinDate">Tham gia: 01/01/2024</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-3 rounded-lg shadow">
                        <p class="text-gray-500">Gi·ªõi t√≠nh</p>
                        <p class="font-bold" id="profileGender">Nam</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow">
                        <p class="text-gray-500">Tu·ªïi</p>
                        <p class="font-bold" id="profileAge">18</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow">
                        <p class="text-gray-500">Ng√†y sinh</p>
                        <p class="font-bold" id="profileBirthDate">01/01/2006</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow">
                        <p class="text-gray-500">L·ªõp ƒëang ch∆°i</p>
                        <p class="font-bold" id="profileGrade">10</p>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button onclick="closeProfileModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                    <span id="closeProfileText">ƒê√≥ng</span>
                </button>
            </div>
        </div>
    </div>

    <!-- STATS MODAL - UPDATED -->
    <div id="statsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75zM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 01-1.875-1.875V8.625zM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 013 19.875v-6.75z" />
                    </svg>
                    <span id="statsTitle">TH·ªêNG K√ä & ƒê√ÅNH GI√Å</span>
                </h2>
                <button onclick="closeStatsModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <!-- Basic Stats -->
            <div class="space-y-3 mb-6">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-500" id="totalGamesText">S·ªë l·∫ßn ch∆°i</p>
                        <p class="text-2xl font-bold text-indigo-600" id="totalGames">0</p>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-500" id="bestScoreText">ƒêi·ªÉm cao nh·∫•t</p>
                        <p class="text-2xl font-bold text-green-600" id="bestScore">0</p>
                    </div>
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-500" id="questionsAnsweredText">C√¢u ƒë√£ tr·∫£ l·ªùi</p>
                        <p class="text-2xl font-bold text-blue-600" id="questionsAnswered">0</p>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-50 to-amber-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-500" id="accuracyText">T·ª∑ l·ªá ƒë√∫ng</p>
                        <p class="text-2xl font-bold text-yellow-600" id="accuracy">0%</p>
                    </div>
                </div>
            </div>
            
            <!-- Assessment Section -->
            <div id="assessmentSection" class="assessment-card">
                <!-- Assessment content will be inserted by JavaScript -->
            </div>
            
            <!-- Subject Stats -->
            <div id="subjectStatsSection" class="mt-6">
                <!-- Subject stats will be inserted by JavaScript -->
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="closeStatsModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                    <span id="closeStatsText">ƒê√≥ng</span>
                </button>
            </div>
        </div>
    </div>

    <!-- T√ÄI KHO·∫¢N TR√äN MENU CH√çNH -->
    <div id="userAccountMenu" class="user-account-menu" style="display: none;">
        <div class="flex items-center space-x-2">
            <div class="relative">
                <button id="mainMenuUserAvatar" onclick="toggleMainMenuUserDropdown()" class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold shadow-lg hover:shadow-xl transition">
                    <span id="mainMenuAvatarText">U</span>
                </button>
                <div id="mainMenuUserDropdown" class="absolute right-0 mt-2 w-48 bg-gray-900 rounded-lg shadow-xl py-2 hidden border border-gray-700">
                    <div class="px-4 py-2 border-b border-gray-700">
                        <p class="font-bold text-white" id="mainMenuDropdownUsername">Username</p>
                        <p class="text-xs text-gray-400" id="mainMenuDropdownStatus">ƒêang ·ªü menu</p>
                    </div>
                    <a href="javascript:void(0)" onclick="showProfile()" class="block px-4 py-2 text-gray-300 hover:bg-indigo-900 hover:text-white transition flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span id="mainMenuProfileText">H·ªì s∆°</span>
                    </a>
                    <a href="javascript:void(0)" onclick="showStats()" class="block px-4 py-2 text-gray-300 hover:bg-indigo-900 hover:text-white transition flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span id="mainMenuStatsText">Th·ªëng k√™</span>
                    </a>
                    <a href="javascript:void(0)" onclick="logout()" class="block px-4 py-2 text-gray-300 hover:bg-red-900 hover:text-white transition flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span id="mainMenuLogoutText">ƒêƒÉng xu·∫•t</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- MENU CH√çNH - ƒê√É S·ª¨A ƒê·ªÇ C√ì THANH CU·ªòN -->
    <div id="mainMenu" style="display: none;">
        <!-- Particles decorative -->
        <div class="particle" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="top: 20%; left: 80%; animation-delay: 0.5s;"></div>
        <div class="particle" style="top: 70%; left: 15%; animation-delay: 1s;"></div>
        <div class="particle" style="top: 60%; left: 85%; animation-delay: 1.5s;"></div>
        <div class="particle" style="top: 40%; left: 50%; animation-delay: 0.8s;"></div>

        <div class="menu-container">
            <h1 class="menu-title">üß† FLAPPY BRAIN</h1>
            <p class="menu-subtitle" id="menuSubtitle">Th·ª≠ th√°ch tr√≠ tu·ªá c·ªßa b·∫°n!</p>
            
            <!-- ========== PH·∫¶N CH·ªåN L·ªöP/M√îN M·ªöI - G·ªåN G√ÄNG ========== -->
            <div class="selection-panel">
                <!-- Ph·∫ßn ch·ªçn l·ªõp -->
                <div class="selection-header">
                    <div class="selection-icon">
                        üéì
                    </div>
                    <h2 id="gradeLabel" class="selection-title">Ch·ªçn l·ªõp h·ªçc</h2>
                </div>
                
                <div class="grade-grid" id="gradeGrid">
                    <!-- L·ªõp 6-12 s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                </div>
                
                <!-- Ph·∫ßn ch·ªçn m√¥n (ch·ªâ hi·ªán v·ªõi l·ªõp 10-12) -->
                <div id="subjectSelection" class="hidden">
                    <div class="selection-header" style="margin-top: 1.5rem;">
                        <div class="selection-icon">
                            üìö
                        </div>
                        <h2 id="subjectLabel" class="selection-title">Ch·ªçn m√¥n h·ªçc</h2>
                    </div>
                    
                    <div class="subject-grid" id="subjectGrid">
                        <!-- C√°c m√¥n h·ªçc s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                    </div>
                </div>
                
                <!-- Hi·ªÉn th·ªã th√¥ng tin ƒë√£ ch·ªçn -->
                <div class="selected-info" id="selectedInfo">
                    <div class="selected-text" id="selectedText">ƒê√£ ch·ªçn:</div>
                    <div class="selected-value" id="selectedValue">L·ªõp 10 ‚Ä¢ T·ªïng h·ª£p</div>
                </div>
            </div>
            
            <div class="menu-buttons">
                <button class="menu-button" onclick="startGame()">
                    <span id="startGameText">‚ñ∂ B·∫ÆT ƒê·∫¶U CH∆†I</span>
                </button>
                <button class="menu-button info" onclick="testBackendConnectionUI()">
                    <span id="testBackendText">üîó KI·ªÇM TRA SERVER</span>
                </button>
                <button class="menu-button secondary" onclick="showSettingsModal()">
                    <span id="settingsText">‚öôÔ∏è C√ÄI ƒê·∫∂T</span>
                </button>
                <button class="menu-button info" onclick="showInfo()">
                    <span id="guideText">üìñ H∆Ø·ªöNG D·∫™N</span>
                </button>
                <button class="menu-button" onclick="showAbout()">
                    <span id="aboutText">‚ÑπÔ∏è GI·ªöI THI·ªÜU</span>
                </button>
            </div>
            
            <!-- TH√äM KHO·∫¢NG TR·ªêNG ·ªû CU·ªêI ƒê·ªÇ D·ªÑ CU·ªòN -->
            <div style="height: 50px;"></div>
        </div>
    </div>

    <!-- SETTINGS MODAL - M·ªöI -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="settings-modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="settings-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path fill-rule="evenodd" d="M12 6.75a5.25 5.25 0 0 1 6.775-5.025.75.75 0 0 1 .313 1.248l-3.32 3.319c.063.475.276.934.641 1.299.365.365.824.578 1.3.64l3.318-3.319a.75.75 0 0 1 1.248.313 5.25 5.25 0 0 1-5.472 6.756c-1.018-.086-1.87.1-2.309.634L7.344 21.3A3.298 3.298 0 1 1 2.7 16.657l8.684-7.151c.533-.44.72-1.291.634-2.309A5.342 5.342 0 0 1 12 6.75ZM4.117 19.125a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75h-.008a.75.75 0 0 1-.75-.75v-.008Z" clip-rule="evenodd" />
                    </svg>
                    <span id="settingsTitle">C√ÄI ƒê·∫∂T TR√í CH∆†I</span>
                </h2>
                <button onclick="hideSettingsModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <div class="scrollable-content">
                <!-- Groq API Key -->
                <div class="setting-group">
                    <label class="setting-label" id="aiApiKeyLabel">ü§ñ Groq API Key:</label>
                    <input type="password" id="groqApiKey" 
                           class="w-full px-3 py-2 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 bg-gray-800 text-white" 
                           placeholder="Nh·∫≠p API key (ƒë·ªÉ tr·ªëng d√πng c√¢u h·ªèi m·∫∑c ƒë·ªãnh)">
                    <p class="text-xs text-gray-400 mt-1" id="apiKeyHelp">
                        L·∫•y key mi·ªÖn ph√≠ t·∫°i <a href="https://console.groq.com/keys" target="_blank" class="text-blue-400 underline">console.groq.com</a>
                    </p>
                </div>

                <!-- M√ÄU N·ªÄN (ƒê√É V√î HI·ªÜU H√ìA - S·∫º D√ôNG H√åNH ·∫¢NH) -->
                <div class="setting-group" style="display: none;">
                    <label class="setting-label" id="bgColorLabel">üé® M√†u n·ªÅn game:</label>
                    <div class="color-grid">
                        <div class="color-option active" style="background: linear-gradient(135deg, #70c5ce 0%, #4a90e2 100%);" onclick="selectBgColor(0)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="selectBgColor(1)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="selectBgColor(2)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="selectBgColor(3)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="selectBgColor(4)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="selectBgColor(5)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);" onclick="selectBgColor(6)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #a3bded 0%, #6991c7 100%);" onclick="selectBgColor(7)"></div>
                    </div>
                </div>

                <!-- M√ÄU CHIM (ƒê√É V√î HI·ªÜU H√ìA - S·∫º D√ôNG H√åNH ·∫¢NH) -->
                <div class="setting-group" style="display: none;">
                    <label class="setting-label" id="birdColorLabel">üê¶ M√†u chim:</label>
                    <div class="color-grid">
                        <div class="color-option active" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="selectBirdColor(0)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);" onclick="selectBirdColor(1)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);" onclick="selectBirdColor(2)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);" onclick="selectBirdColor(3)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);" onclick="selectBirdColor(4)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #a6c0fe 0%, #f68084 100%);" onclick="selectBirdColor(5)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="selectBirdColor(6)"></div>
                        <div class="color-option" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="selectBirdColor(7)"></div>
                    </div>
                </div>

                <!-- T·ªêC ƒê·ªò GAME -->
                <div class="setting-group">
                    <label class="setting-label" id="gameSpeedLabel">‚ö° T·ªëc ƒë·ªô game:</label>
                    <div class="slider-container">
                        <span id="slowText">Ch·∫≠m</span>
                        <input type="range" id="gameSpeedSlider" min="50" max="200" value="100" oninput="updateGameSpeed(this.value)">
                        <span id="fastText">Nhanh</span>
                        <span class="slider-value" id="speedValue">100%</span>
                    </div>
                </div>

                <!-- √ÇM THANH -->
                <div class="setting-group">
                    <label class="setting-label" id="soundLabel">üîä √Çm thanh:</label>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="soundToggleText">B·∫≠t/T·∫Øt √¢m thanh</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundToggle" checked onchange="toggleSound(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- √ÇM L∆Ø·ª¢NG -->
                <div class="setting-group">
                    <label class="setting-label" id="volumeLabel">üîà √Çm l∆∞·ª£ng:</label>
                    <div class="slider-container">
                        <span id="lowText">Nh·ªè</span>
                        <input type="range" id="volumeSlider" min="0" max="100" value="80" oninput="updateVolume(this.value)">
                        <span id="highText">L·ªõn</span>
                        <span class="slider-value" id="volumeValue">80%</span>
                    </div>
                </div>

                <!-- NG√îN NG·ªÆ -->
                <div class="setting-group">
                    <label class="setting-label" id="languageLabel">üåê Ng√¥n ng·ªØ:</label>
                    <div class="language-buttons">
                        <button class="lang-button active" onclick="selectLanguage('vi')">Ti·∫øng Vi·ªát</button>
                        <button class="lang-button" onclick="selectLanguage('en')">English</button>
                    </div>
                </div>

                <!-- ƒê·ªò KH√ì -->
                <div class="setting-group">
                    <label class="setting-label" id="difficultyLabel">üéØ ƒê·ªô kh√≥:</label>
                    <div class="language-buttons">
                        <button class="lang-button active" onclick="selectDifficulty('easy')" id="easyBtn">D·ªÖ</button>
                        <button class="lang-button" onclick="selectDifficulty('medium')" id="mediumBtn">Trung b√¨nh</button>
                        <button class="lang-button" onclick="selectDifficulty('hard')" id="hardBtn">Kh√≥</button>
                    </div>
                </div>

                <!-- KI·ªÇM SO√ÅT -->
                <div class="setting-group">
                    <label class="setting-label" id="controlLabel">üéÆ Ki·ªÉm so√°t:</label>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="touchControlText">Cho ph√©p c·∫£m ·ª©ng</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="touchToggle" checked onchange="toggleTouchControl(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- NEW SETTINGS: EXPLANATION AND AUTO CONTINUE - THI·∫æT K·∫æ GI·ªêNG PH·∫¶N KI·ªÇM SO√ÅT -->
                <div class="setting-group">
                    <label class="setting-label" id="explanationLabel">üí° Hi·ªÉn th·ªã gi·∫£i th√≠ch:</label>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="explanationToggleText">B·∫≠t gi·∫£i th√≠ch AI sau m·ªói c√¢u tr·∫£ l·ªùi</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="showExplanationsToggle" checked onchange="toggleExplanations(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label" id="autoContinueLabel">‚ö° T·ª± ƒë·ªông ti·∫øp t·ª•c:</label>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="autoContinueToggleText">T·ª± ƒë·ªông ti·∫øp t·ª•c game sau khi tr·∫£ l·ªùi</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoContinueToggle" onchange="toggleAutoContinue(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- N√öT H√ÄNH ƒê·ªòNG -->
            <div class="settings-actions">
                <button class="settings-button" onclick="saveSettings()">
                    <span id="saveText">üíæ L∆∞u c√†i ƒë·∫∑t</span>
                </button>
                <button class="settings-button reset" onclick="resetSettings()">
                    <span id="resetText">üîÑ ƒê·∫∑t l·∫°i</span>
                </button>
                <button class="settings-button" onclick="hideSettingsModal()">
                    <span id="closeText">‚úï ƒê√≥ng</span>
                </button>
            </div>
        </div>
    </div>

    <!-- INFO MODAL -->
    <div id="infoModal">
        <div class="info-content">
            <h2 id="modalTitle">H∆∞·ªõng d·∫´n ch∆°i</h2>
            <div id="modalBody">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
            <button class="close-button" onclick="closeModal()" id="closeModalBtn">ƒê√≥ng</button>
        </div>
    </div>

    <!-- WIN MODAL -->
    <div id="winModal">
        <div class="win-content">
            <div class="win-title" id="winTitle">üéâ CHI·∫æN TH·∫ÆNG!</div>
            <div class="win-message" id="winMessage">Ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi l·ªõp <span id="winGrade">10</span>!</div>
            
            <div class="win-stats">
                <div class="stat-item">
                    <span id="winScoreLabel">ƒêi·ªÉm:</span>
                    <span class="stat-value" id="winScore">0</span>
                </div>
                <div class="stat-item">
                    <span id="winQuestionsLabel">C√¢u h·ªèi:</span>
                    <span class="stat-value" id="winAnswered">0</span>/<span id="winTotal">0</span>
                </div>
                <div class="stat-item">
                    <span id="winBestLabel">ƒêi·ªÉm cao nh·∫•t:</span>
                    <span class="stat-value" id="winBest">0</span>
                </div>
            </div>

            <button class="win-button" onclick="returnToMenuFromWin()" id="homeButton">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
                    <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
                </svg>
                <span id="homeText">V·ªÄ TRANG CH·ª¶</span>
            </button>
            
            <button class="win-button secondary" onclick="playAgainFromWin()" id="playAgainButton">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0112.548-3.364l1.903 1.903h-3.183a.75.75 0 100 1.5h4.992a.75.75 0 00.75-0.75V4.356a.75.75 0 00-1.5 0v3.18l-1.9-1.9A9 9 0 003.306 9.67a.75.75 0 101.45.388zm15.408 3.352a.75.75 0 00-.919.53 7.5 7.5 0 01-12.548 3.364l-1.902-1.903h3.183a.75.75 0 000-1.5H2.984a.75.75 0 00-.75.75v4.992a.75.75 0 001.5 0v-3.18l1.9 1.9a9 9 0 0015.059-4.035.75.75 0 00-.53-.918z" clip-rule="evenodd" />
                </svg>
                <span id="playAgainText">CH∆†I L·∫†I</span>
            </button>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div id="explanationModal" class="modal" style="display: none; z-index: 2000;">
        <div class="explanation-modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 id="explanationTitle" class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842a3.75 3.75 0 01-.837.552c-.676.328-1.028.774-1.028 1.152v.75a.75.75 0 01-1.5 0v-.75c0-1.279 1.06-2.107 1.875-2.502.182-.088.351-.199.503-.331.83-.727.83-1.857 0-2.584zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                    </svg>
                    <span>GI·∫¢I TH√çCH ƒê√ÅP √ÅN</span>
                </h3>
                <button onclick="game.closeExplanation()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <div id="explanationLoading" class="explanation-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p id="explanationLoadingText" class="text-gray-600 font-medium">AI ƒëang t·∫°o gi·∫£i th√≠ch...</p>
            </div>
            
            <div id="explanationContent" style="display: none;">
                <div class="question-review mb-4 p-3 bg-indigo-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1 font-semibold">C√¢u h·ªèi:</p>
                    <p id="explanationQuestion" class="text-gray-800 font-medium"></p>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-sm font-bold text-green-600">‚úì ƒê√°p √°n ƒë√∫ng:</span>
                        <span id="explanationCorrectAnswer" class="font-bold"></span>
                    </div>
                    <div id="explanationUserAnswerContainer" class="flex items-center gap-2 mt-1">
                        <span class="text-sm font-bold text-red-600">‚úó B·∫°n ch·ªçn:</span>
                        <span id="explanationUserAnswer" class="font-bold"></span>
                    </div>
                </div>
                
                <div class="explanation-text" id="explanationText">
                    <!-- AI explanation will be inserted here -->
                </div>
                
                <div class="explanation-buttons">
                    <button onclick="game.closeExplanation()" class="explanation-button close">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                        <span id="closeExplanationText">ƒê√≥ng</span>
                    </button>
                    <button onclick="game.continueGame()" class="explanation-button continue">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                        </svg>
                        <span id="continueGameText">Ti·∫øp t·ª•c ch∆°i</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Continue Indicator -->
    <div id="autoContinueIndicator" class="auto-continue-indicator" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
        </svg>
        <span id="autoContinueText">T·ª± ƒë·ªông ti·∫øp t·ª•c...</span>
    </div>

    <!-- N√öT QUAY V·ªÄ MENU TRONG GAME -->
    <button id="returnToMenuButton" 
            style="display: none;"
            class="fixed top-4 right-20 z-50 p-3 rounded-full bg-gray-700 text-white shadow-xl hover:bg-gray-800 transition transform hover:scale-105 active:scale-95" 
            onclick="returnToMenuFromGame()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M9.53 2.47a.75.75 0 010 1.06L4.81 8.25H15a6.75 6.75 0 010 13.5h-3a.75.75 0 010-1.5h3a5.25 5.25 0 100-10.5H4.81l4.72 4.72a.75.75 0 11-1.06 1.06l-6-6a.75.75 0 010-1.06l6-6a.75.75 0 011.06 0z" clip-rule="evenodd" />
        </svg>
    </button>

    <div class="game-container relative">
        <div id="effect-area" class="absolute w-[288px] h-[512px] pointer-events-none"></div>
        <canvas id="gameCanvas" width="288" height="512" class="rounded-xl"></canvas>
    </div>

    <!-- Menu button trong game -->
    <button id="menuButtonInGame" 
            style="display: none;"
            class="fixed top-4 left-4 z-50 p-3 rounded-full bg-purple-600 text-white shadow-xl hover:bg-purple-700 transition transform hover:scale-105 active:scale-95" 
            onclick="returnToMenu();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
        </svg>
    </button>

    <!-- Pause button -->
    <button id="pauseButton" 
            style="display: none;"
            class="fixed top-4 right-4 z-50 p-3 rounded-full bg-yellow-500 text-white shadow-xl hover:bg-yellow-600 transition transform hover:scale-105 active:scale-95" 
            onclick="togglePause();">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd" />
        </svg>
    </button>

    <button id="jumpButton" 
            style="display: none;"
            class="fixed bottom-4 right-4 z-50 p-3 rounded-full bg-indigo-600 text-white shadow-xl hover:bg-indigo-700 transition transform hover:scale-105 active:scale-95" 
            onclick="if (gameState !== 'question' && !isPaused) handleJump(event);">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M11.47 7.72a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06L12 9.31l-6.97 6.97a.75.75 0 0 1-1.06-1.06l7.5-7.5Z" clip-rule="evenodd" />
        </svg>
    </button>

    <!-- Updated Question Modal -->
    <div id="questionModal" class="modal">
        <div class="modal-content-enhanced">
            <div class="flex items-center justify-between mb-3 border-b pb-2">
                <div class="flex items-center gap-2">
                    <div id="questionIcon" class="w-8 h-8 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 text-white flex items-center justify-center text-sm">
                        ‚ùì
                    </div>
                    <h2 id="questionSubject" class="text-base font-extrabold text-indigo-700 uppercase"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="hintButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg shadow-md transition flex items-center text-xs" onclick="game.useHint()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                            <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842a3.75 3.75 0 01-.837.552c-.676.328-1.028.774-1.028 1.152v.75a.75.75 0 01-1.5 0v-.75c0-1.279 1.06-2.107 1.875-2.502.182-.088.351-.199.503-.331.83-.727.83-1.857 0-2.584zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                        </svg>
                        <span id="hintText">G·ª£i √Ω</span> (<span id="hintCountText">0</span>)
                    </button>
                </div>
            </div>
            
            <p id="questionText" class="text-gray-900 text-sm mb-4 font-semibold p-3 border-l-4 border-indigo-500 bg-indigo-50 rounded-r-lg"></p>
            
            <div id="answersContainer" class="space-y-2"></div>
            
            <div id="feedbackContainer" class="mt-4">
                <p id="feedbackMessage" class="text-center text-sm font-extrabold mb-3"></p>
                
                <!-- Continue and Explanation buttons will be inserted here by JavaScript -->
                <div id="actionButtonsContainer"></div>
            </div>
            
            <div class="mt-3 pt-3 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-red-500">
                            <path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                        </svg>
                        <p id="skipMessage" class="text-xs text-gray-600">
                            <span class="text-red-600 font-bold" id="warningText">L∆ØU √ù:</span> 
                            <span id="warningMessage">Sai = Thua!</span>
                        </p>
                    </div>
                    <div id="questionCounter" class="text-xs text-gray-500 font-semibold">
                        C√¢u <span id="currentQuestionNumber">1</span>/<span id="totalQuestions">20</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========== H·ªÜ TH·ªêNG AUTH ==========
        class AuthSystem {
            constructor() {
                this.currentUser = null;
                this.users = this.loadUsers();
                this.isLoggedIn = false;
            }

            loadUsers() {
                const usersJSON = localStorage.getItem('flappyBrainUsers');
                return usersJSON ? JSON.parse(usersJSON) : [];
            }

            saveUsers() {
                localStorage.setItem('flappyBrainUsers', JSON.stringify(this.users));
            }

            usernameExists(username) {
                return this.users.some(user => user.username.toLowerCase() === username.toLowerCase());
            }

            register(username, password, birthDate, gender) {
                if (!username || !password || !birthDate || !gender) {
                    return { success: false, message: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin' };
                }

                if (username.length < 3 || username.length > 20) {
                    return { success: false, message: 'T√™n ƒëƒÉng nh·∫≠p ph·∫£i t·ª´ 3-20 k√Ω t·ª±' };
                }

                if (this.usernameExists(username)) {
                    return { success: false, message: 'T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i' };
                }

                if (password.length < 6) {
                    return { success: false, message: 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±' };
                }

                const birthDateObj = new Date(birthDate);
                const today = new Date();
                const age = today.getFullYear() - birthDateObj.getFullYear();
                
                if (age < 6) {
                    return { success: false, message: 'B·∫°n ph·∫£i t·ª´ 6 tu·ªïi tr·ªü l√™n' };
                }
                if (age > 100) {
                    return { success: false, message: 'Ng√†y sinh kh√¥ng h·ª£p l·ªá' };
                }

                const newUser = {
                    id: Date.now().toString(),
                    username: username.trim(),
                    password: this.hashPassword(password),
                    birthDate: birthDate,
                    gender: gender,
                    createdAt: new Date().toISOString(),
                    stats: {
                        gamesPlayed: 0,
                        bestScore: 0,
                        totalScore: 0,
                        questionsAnswered: 0,
                        correctAnswers: 0,
                        subjectStats: {}, // Th√™m subject stats
                        achievements: []
                    },
                    settings: {
                        volume: 0.8,
                        soundEnabled: true,
                        gameSpeed: 1.0,
                        difficulty: 'easy',
                        language: 'vi',
                        birdColor: 0,
                        bgColor: 0,
                        showExplanations: true, // Th√™m setting m·ªõi
                        autoContinue: false // Th√™m setting m·ªõi
                    }
                };

                this.users.push(newUser);
                this.saveUsers();

                this.currentUser = newUser;
                this.isLoggedIn = true;
                this.saveCurrentUser();

                return { 
                    success: true, 
                    message: 'ƒêƒÉng k√Ω th√†nh c√¥ng!',
                    user: newUser 
                };
            }

            login(username, password) {
                const user = this.users.find(u => 
                    u.username.toLowerCase() === username.toLowerCase()
                );

                if (!user) {
                    return { success: false, message: 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i' };
                }

                if (user.password !== this.hashPassword(password)) {
                    return { success: false, message: 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng' };
                }

                this.currentUser = user;
                this.isLoggedIn = true;
                this.saveCurrentUser();

                return { 
                    success: true, 
                    message: 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!',
                    user: user 
                };
            }

            logout() {
                this.currentUser = null;
                this.isLoggedIn = false;
                localStorage.removeItem('flappyBrainCurrentUser');
                return { success: true, message: 'ƒê√£ ƒëƒÉng xu·∫•t' };
            }

            saveCurrentUser() {
                if (this.currentUser) {
                    localStorage.setItem('flappyBrainCurrentUser', JSON.stringify(this.currentUser));
                }
            }

            loadCurrentUser() {
                const userJSON = localStorage.getItem('flappyBrainCurrentUser');
                if (userJSON) {
                    this.currentUser = JSON.parse(userJSON);
                    this.isLoggedIn = true;
                    return this.currentUser;
                }
                return null;
            }

            updateStats(stats) {
                if (!this.currentUser) return;
                
                Object.keys(stats).forEach(key => {
                    if (typeof this.currentUser.stats[key] === 'number') {
                        this.currentUser.stats[key] += stats[key];
                    }
                });
                
                this.saveUserData();
            }

            updateBestScore(score) {
                if (!this.currentUser) return;
                
                if (score > this.currentUser.stats.bestScore) {
                    this.currentUser.stats.bestScore = score;
                    this.saveUserData();
                }
            }

            updateSettings(newSettings) {
                if (!this.currentUser) return;
                
                Object.assign(this.currentUser.settings, newSettings);
                this.saveUserData();
            }

            getUserSettings() {
                return this.currentUser ? this.currentUser.settings : null;
            }

            saveUserData() {
                if (!this.currentUser) return;
                
                const index = this.users.findIndex(u => u.id === this.currentUser.id);
                if (index !== -1) {
                    this.users[index] = this.currentUser;
                    this.saveUsers();
                    this.saveCurrentUser();
                }
            }

            hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }

            getUserInfo() {
                if (!this.currentUser) return null;
                
                const birthDate = new Date(this.currentUser.birthDate);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                
                return {
                    username: this.currentUser.username,
                    birthDate: this.currentUser.birthDate,
                    age: age,
                    gender: this.currentUser.gender,
                    joinDate: new Date(this.currentUser.createdAt).toLocaleDateString('vi-VN'),
                    stats: { ...this.currentUser.stats }
                };
            }

            // NEW METHODS FOR DETAILED STATS
            updateQuestionStats(subject, correct) {
                if (!this.currentUser) return;
                
                // Initialize subject stats if not exists
                if (!this.currentUser.stats.subjectStats) {
                    this.currentUser.stats.subjectStats = {};
                }
                
                if (!this.currentUser.stats.subjectStats[subject]) {
                    this.currentUser.stats.subjectStats[subject] = {
                        total: 0,
                        correct: 0,
                        lastUpdated: new Date().toISOString()
                    };
                }
                
                // Update stats
                this.currentUser.stats.subjectStats[subject].total++;
                if (correct) {
                    this.currentUser.stats.subjectStats[subject].correct++;
                }
                this.currentUser.stats.subjectStats[subject].lastUpdated = new Date().toISOString();
                
                // Update overall stats
                this.updateStats({
                    questionsAnswered: 1,
                    correctAnswers: correct ? 1 : 0
                });
                
                this.saveUserData();
            }

            getDetailedStats() {
                if (!this.currentUser) return null;
                
                const stats = this.currentUser.stats;
                const subjectStats = stats.subjectStats || {};
                
                // Calculate accuracy
                const accuracy = stats.questionsAnswered > 0 ? 
                    Math.round((stats.correctAnswers / stats.questionsAnswered) * 100) : 0;
                
                return {
                    basic: {
                        gamesPlayed: stats.gamesPlayed || 0,
                        bestScore: stats.bestScore || 0,
                        totalScore: stats.totalScore || 0,
                        questionsAnswered: stats.questionsAnswered || 0,
                        correctAnswers: stats.correctAnswers || 0,
                        accuracy: accuracy
                    },
                    subjects: subjectStats
                };
            }

            getSkillAssessment() {
                if (!this.currentUser) return null;
                
                const stats = this.getDetailedStats();
                if (!stats || !stats.subjects) return null;
                
                // Calculate overall score based on accuracy and questions answered
                let totalScore = 0;
                let totalWeight = 0;
                
                Object.entries(stats.subjects).forEach(([subject, subjectStats]) => {
                    if (subjectStats.total > 0) {
                        const accuracy = Math.round((subjectStats.correct / subjectStats.total) * 100);
                        const weight = Math.min(subjectStats.total, 10); // Max weight 10 per subject
                        
                        totalScore += accuracy * weight;
                        totalWeight += weight;
                    }
                });
                
                const overallScore = totalWeight > 0 ? Math.round(totalScore / totalWeight) : 0;
                
                return {
                    overall: overallScore,
                    lastUpdated: new Date().toISOString(),
                    subjects: stats.subjects
                };
            }
        }

        const auth = new AuthSystem();

        // ========== AUTH FUNCTIONS ==========
        function initAuth() {
            const savedUser = auth.loadCurrentUser();
            if (savedUser) {
                updateUIForLoggedInUser(savedUser);
                loadUserSettings(savedUser.settings);
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
                document.getElementById('userAccountMenu').style.display = 'block';
            } else {
                document.getElementById('authModal').style.display = 'flex';
                document.getElementById('userAccountMenu').style.display = 'none';
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                loginTab.classList.remove('text-gray-500');
                loginTab.classList.add('text-purple-400', 'border-b-2', 'border-purple-400');
                registerTab.classList.remove('active', 'text-purple-400', 'border-b-2', 'border-purple-400');
                registerTab.classList.add('text-gray-300');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                registerTab.classList.remove('text-gray-300');
                registerTab.classList.add('text-purple-400', 'border-b-2', 'border-purple-400');
                loginTab.classList.remove('active', 'text-purple-400', 'border-b-2', 'border-purple-400');
                loginTab.classList.add('text-gray-300');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const messageEl = document.getElementById('loginMessage');
            
            if (!username || !password) {
                messageEl.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin';
                messageEl.className = 'mb-4 text-sm text-center text-red-400';
                return;
            }
            
            const result = auth.login(username, password);
            
            if (result.success) {
                messageEl.textContent = result.message;
                messageEl.className = 'mb-4 text-sm text-center text-green-400';
                
                updateUIForLoggedInUser(result.user);
                loadUserSettings(result.user.settings);
                
                setTimeout(() => {
                    hideAuthModal();
                    document.getElementById('mainMenu').style.display = 'flex';
                    document.getElementById('userAccountMenu').style.display = 'block';
                }, 1000);
            } else {
                messageEl.textContent = result.message;
                messageEl.className = 'mb-4 text-sm text-center text-red-400';
            }
        }

        function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const birthDate = document.getElementById('birthDate').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            const messageEl = document.getElementById('registerMessage');
            
            if (password !== confirmPassword) {
                messageEl.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp';
                messageEl.className = 'mb-4 text-sm text-center text-red-400';
                return;
            }
            
            if (!username || !password || !birthDate || !gender) {
                messageEl.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin';
                messageEl.className = 'mb-4 text-sm text-center text-red-400';
                return;
            }
            
            const result = auth.register(username, password, birthDate, gender);
            
            if (result.success) {
                messageEl.textContent = result.message;
                messageEl.className = 'mb-4 text-sm text-center text-green-400';
                
                updateUIForLoggedInUser(result.user);
                loadUserSettings(result.user.settings);
                
                setTimeout(() => {
                    hideAuthModal();
                    document.getElementById('mainMenu').style.display = 'flex';
                    document.getElementById('userAccountMenu').style.display = 'block';
                }, 1000);
            } else {
                messageEl.textContent = result.message;
                messageEl.className = 'mb-4 text-sm text-center text-red-400';
            }
        }

        function updateUIForLoggedInUser(user) {
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('userAccountMenu').style.display = 'block';
            
            document.getElementById('usernameDisplay').textContent = user.username;
            document.getElementById('scoreDisplay').textContent = `ƒêi·ªÉm cao: ${user.stats.bestScore}`;
            document.getElementById('dropdownUsername').textContent = user.username;
            document.getElementById('avatarText').textContent = user.username.charAt(0).toUpperCase();
            document.getElementById('profileAvatar').textContent = user.username.charAt(0).toUpperCase();
            
            document.getElementById('mainMenuAvatarText').textContent = user.username.charAt(0).toUpperCase();
            document.getElementById('mainMenuDropdownUsername').textContent = user.username;
            
            document.getElementById('menuButtonInGame').style.display = 'none';
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('hidden');
        }

        function toggleMainMenuUserDropdown() {
            const dropdown = document.getElementById('mainMenuUserDropdown');
            dropdown.classList.toggle('hidden');
        }

        function showProfile() {
            const userInfo = auth.getUserInfo();
            if (!userInfo) return;
            
            document.getElementById('profileUsername').textContent = userInfo.username;
            document.getElementById('profileAvatar').textContent = userInfo.username.charAt(0).toUpperCase();
            document.getElementById('profileGender').textContent = userInfo.gender === 'male' ? 'Nam' : 
                                                            userInfo.gender === 'female' ? 'N·ªØ' : 'Kh√°c';
            document.getElementById('profileAge').textContent = userInfo.age;
            document.getElementById('profileBirthDate').textContent = new Date(userInfo.birthDate).toLocaleDateString('vi-VN');
            document.getElementById('profileJoinDate').textContent = `Tham gia: ${userInfo.joinDate}`;
            document.getElementById('profileGrade').textContent = selectedGrade;
            
            document.getElementById('userDropdown').classList.add('hidden');
            document.getElementById('mainMenuUserDropdown').classList.add('hidden');
            document.getElementById('profileModal').style.display = 'flex';
        }

        function showStats() {
            const userInfo = auth.getUserInfo();
            if (!userInfo) return;
            
            const stats = userInfo.stats;
            document.getElementById('totalGames').textContent = stats.gamesPlayed;
            document.getElementById('bestScore').textContent = stats.bestScore;
            document.getElementById('totalScore').textContent = stats.totalScore;
            document.getElementById('questionsAnswered').textContent = stats.questionsAnswered;
            document.getElementById('correctAnswers').textContent = stats.correctAnswers;
            
            const accuracy = stats.questionsAnswered > 0 ? 
                Math.round((stats.correctAnswers / stats.questionsAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            
            document.getElementById('userDropdown').classList.add('hidden');
            document.getElementById('mainMenuUserDropdown').classList.add('hidden');
            document.getElementById('statsModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function logout() {
            const result = auth.logout();
            if (result.success) {
                document.getElementById('userMenu').style.display = 'none';
                document.getElementById('userAccountMenu').style.display = 'none';
                document.getElementById('menuButtonInGame').style.display = 'flex';
                showAuthModal();
                document.getElementById('mainMenu').style.display = 'none';
                
                if (game) {
                    game.reset();
                    gameState = 'ready';
                }
            }
        }

        function loadUserSettings(userSettings) {
            if (!userSettings) return;
            
            settings.volume = userSettings.volume || settings.volume;
            settings.soundEnabled = userSettings.soundEnabled !== undefined ? userSettings.soundEnabled : settings.soundEnabled;
            settings.gameSpeed = userSettings.gameSpeed || settings.gameSpeed;
            settings.difficulty = userSettings.difficulty || settings.difficulty;
            settings.language = userSettings.language || settings.language;
            settings.currentBirdColor = userSettings.birdColor || settings.currentBirdColor;
            settings.currentBgColor = userSettings.bgColor || settings.currentBgColor;
            settings.showExplanations = userSettings.showExplanations !== undefined ? userSettings.showExplanations : true;
            settings.autoContinue = userSettings.autoContinue !== undefined ? userSettings.autoContinue : false;
            
            updateAllSettingsUI();
            updateLanguageTexts();
            applyAllSettings();
        }

        function saveUserSettings() {
            if (!auth.isLoggedIn) return;
            
            const userSettings = {
                volume: settings.volume,
                soundEnabled: settings.soundEnabled,
                gameSpeed: settings.gameSpeed,
                difficulty: settings.difficulty,
                language: settings.language,
                birdColor: settings.currentBirdColor,
                bgColor: settings.currentBgColor,
                showExplanations: settings.showExplanations,
                autoContinue: settings.autoContinue
            };
            
            auth.updateSettings(userSettings);
        }

        function updateGameStats() {
            if (!auth.isLoggedIn || !game) return;
            
            const statsUpdate = {
                gamesPlayed: 1,
                totalScore: game.score
            };
            
            auth.updateStats(statsUpdate);
            auth.updateBestScore(game.score);
        }

        // ========== H·ªÜ TH·ªêNG C√ÄI ƒê·∫∂T ==========
        const settings = {
            bgColors: [
                ['#70c5ce', '#4a90e2'],
                ['#667eea', '#764ba2'],
                ['#f093fb', '#f5576c'],
                ['#4facfe', '#00f2fe'],
                ['#43e97b', '#38f9d7'],
                ['#fa709a', '#fee140'],
                ['#30cfd0', '#330867'],
                ['#a3bded', '#6991c7']
            ],
            
            birdColors: [
                ['#4facfe', '#00f2fe'],
                ['#ff9a9e', '#fad0c4'],
                ['#a1c4fd', '#c2e9fb'],
                ['#84fab0', '#8fd3f4'],
                ['#d4fc79', '#96e6a1'],
                ['#a6c0fe', '#f68084'],
                ['#f093fb', '#f5576c'],
                ['#4facfe', '#00f2fe']
            ],
            
            currentBgColor: 0,
            currentBirdColor: 0,
            gameSpeed: 1.0,
            soundEnabled: true,
            volume: 0.8,
            language: 'vi',
            difficulty: 'easy',
            touchControl: true,
            showExplanations: true,
            autoContinue: false
        };

        // ========== DANH S√ÅCH L·ªúI KHEN ==========
        const praiseMessages = {
            vi: [
                "Xu·∫•t s·∫Øc! üéØ",
                "Gi·ªèi qu√°! üåü",
                "Ch√≠nh x√°c! ‚úÖ",
                "Ho√†n h·∫£o! üíØ",
                "Th√¥ng minh! üß†",
                "Tuy·ªát v·ªùi! üëç",
                "Qu√° ƒë·ªânh! ‚ö°",
                "C·ª±c k·ª≥ ch√≠nh x√°c! üéØ",
                "B·∫°n th·∫≠t th√¥ng minh! üß†",
                "Tr·∫£ l·ªùi qu√° hay! üëè",
                "Kh√¥ng th·ªÉ tin n·ªïi! ü§Ø",
                "ƒê·ªânh cao tri th·ª©c! üìö",
                "Si√™u sao h·ªçc t·∫≠p! üåü",
                "B·∫≠c th·∫ßy ki·∫øn th·ª©c! üéì",
                "Qu√° xu·∫•t s·∫Øc! üèÜ"
            ],
            en: [
                "Excellent! üéØ",
                "Great job! üåü",
                "Perfect! ‚úÖ",
                "Awesome! üíØ",
                "Brilliant! üß†",
                "Amazing! üëç",
                "Outstanding! ‚ö°",
                "Absolutely correct! üéØ",
                "You're so smart! üß†",
                "Fantastic answer! üëè",
                "Unbelievable! ü§Ø",
                "Knowledge master! üìö",
                "Study superstar! üåü",
                "Genius level! üéì",
                "Absolutely brilliant! üèÜ"
            ]
        };

        // ========== H√ÄM HI·ªÇN TH·ªä L·ªúI KHEN - ƒê√É S·ª¨A: TƒÇNG TH·ªúI GIAN HI·ªÇN TH·ªä ==========
        function showPraiseNotification() {
            // X√≥a th√¥ng b√°o c≈© n·∫øu c√≥
            const oldNotification = document.querySelector('.praise-notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            // Ch·ªçn ng·∫´u nhi√™n l·ªùi khen
            const lang = settings.language;
            const messages = praiseMessages[lang] || praiseMessages.vi;
            const randomPraise = messages[Math.floor(Math.random() * messages.length)];
            
            // T·∫°o th√¥ng b√°o m·ªõi
            const notification = document.createElement('div');
            notification.className = 'praise-notification';
            notification.textContent = randomPraise;
            
            // Th√™m v√†o body
            document.body.appendChild(notification);
            
            // THAY ƒê·ªîI: T·ª± ƒë·ªông x√≥a sau 3 gi√¢y (thay v√¨ 2 gi√¢y)
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000); // ƒê√É S·ª¨A: 3000ms = 3 gi√¢y
        }

        // ========== H√ÄM QU·∫¢N L√ù SETTINGS MODAL ==========
        function showSettingsModal() {
            console.log('üì± M·ªü settings modal');
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'flex';
                loadSettings(); // T·∫£i c√†i ƒë·∫∑t hi·ªán t·∫°i
            } else {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y settings modal');
            }
        }

        function hideSettingsModal() {
            console.log('üì± ƒê√≥ng settings modal');
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ========== TEXTS ƒêA NG√îN NG·ªÆ ==========
        const texts = {
            vi: {
                // Menu ch√≠nh
                menuSubtitle: "Th·ª≠ th√°ch tr√≠ tu·ªá c·ªßa b·∫°n!",
                gradeLabel: "Ch·ªçn l·ªõp h·ªçc:",
                subjectLabel: "Ch·ªçn m√¥n h·ªçc:",
                allSubjects: "T·ªïng h·ª£p",
                grade6: "L·ªõp 6",
                grade7: "L·ªõp 7", 
                grade8: "L·ªõp 8",
                grade9: "L·ªõp 9",
                grade10: "L·ªõp 10",
                grade11: "L·ªõp 11",
                grade12: "L·ªõp 12",
                startGame: "‚ñ∂ B·∫ÆT ƒê·∫¶U CH∆†I",
                settings: "‚öôÔ∏è C√ÄI ƒê·∫∂T",
                guide: "üìñ H∆Ø·ªöNG D·∫™N",
                about: "‚ÑπÔ∏è GI·ªöI THI·ªÜU",
                generatingQuestions: "ƒêang t·∫°o c√¢u h·ªèi...",
                
                // C√†i ƒë·∫∑t
                settingsTitle: "C√ÄI ƒê·∫∂T TR√í CH∆†I",
                aiApiKeyLabel: "ü§ñ Groq API Key:",
                apiKeyHelp: "L·∫•y key mi·ªÖn ph√≠ t·∫°i console.groq.com",
                bgColorLabel: "üé® M√†u n·ªÅn game:",
                birdColorLabel: "üê¶ M√†u chim:",
                gameSpeedLabel: "‚ö° T·ªëc ƒë·ªô game:",
                slow: "Ch·∫≠m",
                fast: "Nhanh",
                soundLabel: "üîä √Çm thanh:",
                soundToggle: "B·∫≠t/T·∫Øt √¢m thanh",
                volumeLabel: "üîà √Çm l∆∞·ª£ng:",
                low: "Nh·ªè",
                high: "L·ªõn",
                languageLabel: "üåê Ng√¥n ng·ªØ:",
                difficultyLabel: "üéØ ƒê·ªô kh√≥:",
                easy: "D·ªÖ",
                medium: "Trung b√¨nh",
                hard: "Kh√≥",
                controlLabel: "üéÆ Ki·ªÉm so√°t:",
                touchControl: "Cho ph√©p c·∫£m ·ª©ng",
                save: "üíæ L∆∞u c√†i ƒë·∫∑t",
                reset: "üîÑ ƒê·∫∑t l·∫°i",
                close: "‚úï ƒê√≥ng",
                
                // New settings texts
                explanationLabel: "üí° Hi·ªÉn th·ªã gi·∫£i th√≠ch:",
                explanationToggleText: "B·∫≠t gi·∫£i th√≠ch AI sau m·ªói c√¢u tr·∫£ l·ªùi",
                autoContinueLabel: "‚ö° T·ª± ƒë·ªông ti·∫øp t·ª•c:",
                autoContinueToggleText: "T·ª± ƒë·ªông ti·∫øp t·ª•c game sau khi tr·∫£ l·ªùi",
                
                // Game
                tapToFly: "CH·∫†M ƒê·ªÇ BAY",
                gameOver: "THUA CU·ªòC",
                score: "ƒêi·ªÉm",
                best: "Cao nh·∫•t",
                tapToPlayAgain: "CH·∫†M ƒê·ªÇ CH∆†I L·∫†I",
                returnToMenu: "‚Ü© QUAY V·ªÄ MENU",
                victory: "üéâ CHI·∫æN TH·∫ÆNG!",
                completedQuestions: "Ho√†n th√†nh c√¢u h·ªèi!",
                pause: "‚è∏Ô∏è T·∫†M D·ª™NG",
                continue: "TI·∫æP T·ª§C",
                
                // Question modal
                hint: "G·ª£i √ù",
                warning: "L∆ØU √ù:",
                warningMessage: "Sai = Thua!",
                correct: "ƒê√öNG! +5 ƒêI·ªÇM",
                wrong: "SAI! K·∫æT TH√öC",
                lastQuestion: "C√ÇU H·ªéI CU·ªêI!",
                
                // New game texts
                continueGame: "Ti·∫øp t·ª•c ch∆°i",
                showExplanation: "Gi·∫£i th√≠ch ƒë√°p √°n",
                explanationTitle: "GI·∫¢I TH√çCH ƒê√ÅP √ÅN",
                closeExplanation: "ƒê√≥ng",
                aiExplanation: "AI ƒëang t·∫°o gi·∫£i th√≠ch...",
                autoContinueText: "T·ª± ƒë·ªông ti·∫øp t·ª•c...",
                
                // Assessment texts
                skillAssessment: "ƒê√°nh gi√° nƒÉng l·ª±c",
                overallScore: "ƒêi·ªÉm t·ªïng th·ªÉ",
                bySubject: "Th·ªëng k√™ theo m√¥n h·ªçc",
                excellent: "Xu·∫•t s·∫Øc",
                good: "Gi·ªèi",
                average: "Kh√°",
                needImprovement: "C·∫ßn c·ªë g·∫Øng",
                
                // Win modal
                winTitle: "üéâ CHI·∫æN TH·∫ÆNG!",
                winMessage: "Ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi l·ªõp ",
                winScore: "ƒêi·ªÉm:",
                winQuestions: "C√¢u h·ªèi:",
                winBest: "ƒêi·ªÉm cao nh·∫•t:",
                home: "V·ªÄ TRANG CH·ª¶",
                playAgain: "CH∆†I L·∫†I",
                
                // Modal
                closeModal: "ƒê√≥ng",
                
                // Auth
                loginTab: "ƒêƒÇNG NH·∫¨P",
                registerTab: "ƒêƒÇNG K√ù",
                loginUsername: "T√™n ƒëƒÉng nh·∫≠p:",
                loginPassword: "M·∫≠t kh·∫©u:",
                loginButton: "ƒêƒÇNG NH·∫¨P",
                switchToRegister: "Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay",
                registerUsername: "T√™n ƒëƒÉng nh·∫≠p*:",
                usernameHelp: "M·ªói t√™n ƒëƒÉng nh·∫≠p ch·ªâ ƒë∆∞·ª£c d√πng m·ªôt l·∫ßn",
                registerPassword: "M·∫≠t kh·∫©u*:",
                confirmPassword: "X√°c nh·∫≠n m·∫≠t kh·∫©u*:",
                birthDate: "Ng√†y sinh*:",
                gender: "Gi·ªõi t√≠nh*:",
                genderMale: "Nam",
                genderFemale: "N·ªØ",
                genderOther: "Kh√°c",
                registerButton: "ƒêƒÇNG K√ù T√ÄI KHO·∫¢N",
                switchToLogin: "ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p",
                profile: "H·ªì s∆°",
                stats: "Th·ªëng k√™",
                logout: "ƒêƒÉng xu·∫•t",
                profileTitle: "H·ªí S∆† NG∆Ø·ªúI D√ôNG",
                statsTitle: "TH·ªêNG K√ä & ƒê√ÅNH GI√Å",
                totalGames: "S·ªë l·∫ßn ch∆°i",
                bestScore: "ƒêi·ªÉm cao nh·∫•t",
                totalScore: "T·ªïng ƒëi·ªÉm",
                questionsAnswered: "C√¢u h·ªèi ƒë√£ tr·∫£ l·ªùi",
                correctAnswers: "C√¢u tr·∫£ l·ªùi ƒë√∫ng",
                accuracy: "T·ª∑ l·ªá ƒë√∫ng",
                closeProfile: "ƒê√≥ng",
                closeStats: "ƒê√≥ng"
            },
            en: {
                // Main menu
                menuSubtitle: "Challenge your brain!",
                gradeLabel: "Select grade:",
                subjectLabel: "Select subject:",
                allSubjects: "All subjects",
                grade6: "Grade 6",
                grade7: "Grade 7",
                grade8: "Grade 8",
                grade9: "Grade 9",
                grade10: "Grade 10",
                grade11: "Grade 11",
                grade12: "Grade 12",
                startGame: "‚ñ∂ START GAME",
                settings: "‚öôÔ∏è SETTINGS",
                guide: "üìñ GUIDE",
                about: "‚ÑπÔ∏è ABOUT",
                generatingQuestions: "Generating questions...",
                
                // Settings
                settingsTitle: "GAME SETTINGS",
                aiApiKeyLabel: "ü§ñ Groq API Key:",
                apiKeyHelp: "Get free key at console.groq.com",
                bgColorLabel: "üé® Background color:",
                birdColorLabel: "üê¶ Bird color:",
                gameSpeedLabel: "‚ö° Game speed:",
                slow: "Slow",
                fast: "Fast",
                soundLabel: "üîä Sound:",
                soundToggle: "Enable/Disable sound",
                volumeLabel: "üîà Volume:",
                low: "Low",
                high: "High",
                languageLabel: "üåê Language:",
                difficultyLabel: "üéØ Difficulty:",
                easy: "Easy",
                medium: "Medium",
                hard: "Hard",
                controlLabel: "üéÆ Controls:",
                touchControl: "Allow touch control",
                save: "üíæ Save settings",
                reset: "üîÑ Reset",
                close: "‚úï Close",
                
                // New settings texts
                explanationLabel: "üí° Show explanations:",
                explanationToggleText: "Show AI explanation after each answer",
                autoContinueLabel: "‚ö° Auto continue:",
                autoContinueToggleText: "Auto continue game after answering",
                
                // Game
                tapToFly: "TAP TO FLY",
                gameOver: "GAME OVER",
                score: "Score",
                best: "Best",
                tapToPlayAgain: "TAP TO PLAY AGAIN",
                returnToMenu: "‚Ü© BACK TO MENU",
                victory: "üéâ VICTORY!",
                completedQuestions: "Completed questions!",
                pause: "‚è∏Ô∏è PAUSED",
                continue: "CONTINUE",
                
                // Question modal
                hint: "Hint",
                warning: "WARNING:",
                warningMessage: "Wrong = Game Over!",
                correct: "CORRECT! +5 POINTS",
                wrong: "WRONG! GAME OVER",
                lastQuestion: "LAST QUESTION!",
                
                // New game texts
                continueGame: "Continue Game",
                showExplanation: "Explain Answer",
                explanationTitle: "ANSWER EXPLANATION",
                closeExplanation: "Close",
                aiExplanation: "AI is creating explanation...",
                autoContinueText: "Auto continuing...",
                
                // Assessment texts
                skillAssessment: "Skill Assessment",
                overallScore: "Overall Score",
                bySubject: "Statistics by Subject",
                excellent: "Excellent",
                good: "Good",
                average: "Average",
                needImprovement: "Need Improvement",
                
                // Win modal
                winTitle: "üéâ VICTORY!",
                winMessage: "Completed all questions for grade ",
                winScore: "Score:",
                winQuestions: "Questions:",
                winBest: "Best score:",
                home: "BACK TO HOME",
                playAgain: "PLAY AGAIN",
                
                // Modal
                closeModal: "Close",
                
                // Auth
                loginTab: "LOGIN",
                registerTab: "REGISTER",
                loginUsername: "Username:",
                loginPassword: "Password:",
                loginButton: "LOGIN",
                switchToRegister: "Don't have an account? Register now",
                registerUsername: "Username*:",
                usernameHelp: "Each username can only be used once",
                registerPassword: "Password*:",
                confirmPassword: "Confirm Password*:",
                birthDate: "Birth Date*:",
                gender: "Gender*:",
                genderMale: "Male",
                genderFemale: "Female",
                genderOther: "Other",
                registerButton: "REGISTER ACCOUNT",
                switchToLogin: "Already have an account? Login",
                profile: "Profile",
                stats: "Statistics",
                logout: "Logout",
                profileTitle: "USER PROFILE",
                statsTitle: "STATISTICS & ASSESSMENT",
                totalGames: "Games Played",
                bestScore: "Best Score",
                totalScore: "Total Score",
                questionsAnswered: "Questions Answered",
                correctAnswers: "Correct Answers",
                accuracy: "Accuracy Rate",
                closeProfile: "Close",
                closeStats: "Close"
            }
        };

        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let selectedGrade = 10;    // L·ªõp ƒë∆∞·ª£c ch·ªçn (m·∫∑c ƒë·ªãnh l·ªõp 10)
        let selectedSubject = 'all'; // M√¥n ƒë∆∞·ª£c ch·ªçn (m·∫∑c ƒë·ªãnh T·ªïng h·ª£p)
        let isPaused = false;

        // ========== BACKEND CONFIG ==========
        const BACKEND_CONFIG = {
            url:'http://127.0.0.1:3000', // URL backend c·ªßa b·∫°n
            timeout: 15000, // 15 gi√¢y timeout
            maxRetries: 3
        };
        
        let isBackendAvailable = false;
        let backendCheckAttempted = false;

        // ========== THI·∫æT L·∫¨P PH·∫¶N CH·ªåN L·ªöP/M√îN M·ªöI ==========
        function setupGradeSubjectSelection() {
            const gradeGrid = document.getElementById('gradeGrid');
            const subjectGrid = document.getElementById('subjectGrid');
            
            // T·∫°o c√°c √¥ ch·ªçn l·ªõp 6-12
            const grades = [6, 7, 8, 9, 10, 11, 12];
            gradeGrid.innerHTML = grades.map(grade => `
                <div class="grade-item ${grade === 10 ? 'active' : ''}" data-grade="${grade}" onclick="selectGrade(${grade})">
                    <div class="grade-number">${grade}</div>
                    <div class="grade-label" id="gradeLabel${grade}">${texts[settings.language][`grade${grade}`]}</div>
                </div>
            `).join('');
            
            // T·∫°o c√°c √¥ ch·ªçn m√¥n h·ªçc
            const subjects = [
                { id: 'all', name: texts[settings.language].allSubjects, icon: 'üìö' },
                { id: 'To√°n', name: 'To√°n', icon: '‚ûó' },
                { id: 'L√Ω', name: 'V·∫≠t L√Ω', icon: '‚ö°' },
                { id: 'H√≥a', name: 'H√≥a H·ªçc', icon: 'üß™' },
                { id: 'Sinh', name: 'Sinh H·ªçc', icon: 'üß¨' },
                { id: 'VƒÉn', name: 'Ng·ªØ VƒÉn', icon: 'üìù' },
                { id: 'Anh', name: 'Ti·∫øng Anh', icon: 'üî§' },
                { id: 'S·ª≠', name: 'L·ªãch S·ª≠', icon: 'üèõÔ∏è' },
                { id: 'ƒê·ªãa', name: 'ƒê·ªãa L√Ω', icon: 'üåç' }
            ];
            
            subjectGrid.innerHTML = subjects.map(subject => `
                <div class="subject-item ${subject.id === 'all' ? 'active' : ''}" data-subject="${subject.id}" onclick="selectSubject('${subject.id}')">
                    <div class="subject-icon">${subject.icon}</div>
                    <div class="subject-name">${subject.name}</div>
                </div>
            `).join('');
            
            // C·∫≠p nh·∫≠t th√¥ng tin ƒë√£ ch·ªçn
            updateSelectedInfo();
        }
        
        function selectGrade(grade) {
            selectedGrade = grade;
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i active
            document.querySelectorAll('.grade-item').forEach(item => {
                item.classList.toggle('active', parseInt(item.dataset.grade) === grade);
            });
            
            // Hi·ªán/·∫©n ph·∫ßn ch·ªçn m√¥n
            const subjectSelection = document.getElementById('subjectSelection');
            if (grade >= 10) {
                subjectSelection.classList.remove('hidden');
            } else {
                subjectSelection.classList.add('hidden');
                // Reset v·ªÅ T·ªïng h·ª£p khi kh√¥ng ph·∫£i c·∫•p 3
                selectedSubject = 'all';
                document.querySelectorAll('.subject-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.subject === 'all');
                });
            }
            
            // C·∫≠p nh·∫≠t th√¥ng tin ƒë√£ ch·ªçn
            updateSelectedInfo();
            
            // Hi·ªáu ·ª©ng
            showSelectionEffect(`ƒê√£ ch·ªçn l·ªõp ${grade}`, '#4ade80');
        }
        
        function selectSubject(subject) {
            selectedSubject = subject;
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i active
            document.querySelectorAll('.subject-item').forEach(item => {
                item.classList.toggle('active', item.dataset.subject === subject);
            });
            
            // C·∫≠p nh·∫≠t th√¥ng tin ƒë√£ ch·ªçn
            updateSelectedInfo();
            
            // Hi·ªáu ·ª©ng
            const subjectName = subject === 'all' ? 'T·∫•t c·∫£ m√¥n' : `M√¥n ${subject}`;
            showSelectionEffect(subjectName, '#f093fb');
        }
        
        function updateSelectedInfo() {
            const selectedText = document.getElementById('selectedText');
            const selectedValue = document.getElementById('selectedValue');
            
            const t = texts[settings.language];
            let subjectText = '';
            
            if (selectedSubject === 'all') {
                subjectText = t.allSubjects;
            } else {
                // T√¨m t√™n m√¥n t·ª´ subject grid
                const subjectItem = document.querySelector(`.subject-item[data-subject="${selectedSubject}"] .subject-name`);
                subjectText = subjectItem ? subjectItem.textContent : selectedSubject;
            }
            
            selectedText.textContent = t.language === 'vi' ? 'ƒê√£ ch·ªçn:' : 'Selected:';
            selectedValue.textContent = `${t[`grade${selectedGrade}`]} ‚Ä¢ ${subjectText}`;
        }
        
        function showSelectionEffect(text, color) {
            const effectArea = document.getElementById('effect-area');
            if (!effectArea) return;
            
            const e = document.createElement('div');
            e.textContent = text;
            e.className = 'score-plus-effect';
            e.style.left = '50%';
            e.style.top = '50%';
            e.style.color = color;
            e.style.fontSize = '1.5rem';
            effectArea.appendChild(e);
            setTimeout(() => e.remove(), 1500);
        }

        // ========== MAP SUBJECT TO BACKEND ==========
        function mapSubjectToBackend(subject) {
            const mapping = {
                'To√°n': 'To√°n h·ªçc',
                'L√Ω': 'V·∫≠t l√Ω', 
                'H√≥a': 'H√≥a h·ªçc',
                'Sinh': 'Sinh h·ªçc',
                'VƒÉn': 'Ng·ªØ vƒÉn',
                'Anh': 'Ti·∫øng Anh',
                'S·ª≠': 'L·ªãch s·ª≠',
                'ƒê·ªãa': 'ƒê·ªãa l√Ω',
                'all': 'all'
            };
            return mapping[subject] || subject;
        }
        async function generateQuestions(grade, subject = 'all', num = 20) {
            console.log(`üéØ generateQuestions: L·ªõp ${grade}, M√¥n: ${subject}`);
            
            // Map subject - v·ªõi fallback n·∫øu h√†m kh√¥ng t·ªìn t·∫°i
            let backendSubject = subject;
            if (typeof mapSubjectToBackend === 'function') {
                backendSubject = mapSubjectToBackend(subject);
            } else {
                // Fallback mapping n·∫øu h√†m ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
                console.warn('‚ö†Ô∏è H√†m mapSubjectToBackend kh√¥ng t·ªìn t·∫°i, d√πng fallback mapping');
                const fallbackMapping = {
                    'S·ª≠': 'L·ªãch s·ª≠',
                    'To√°n': 'To√°n h·ªçc',
                    'L√Ω': 'V·∫≠t l√Ω',
                    'H√≥a': 'H√≥a h·ªçc',
                    'Sinh': 'Sinh h·ªçc',
                    'VƒÉn': 'Ng·ªØ vƒÉn',
                    'Anh': 'Ti·∫øng Anh',
                    'ƒê·ªãa': 'ƒê·ªãa l√Ω',
                    'all': 'all'
                };
                backendSubject = fallbackMapping[subject] || subject;
            }
            
            console.log(`üî§ Subject mapping: ${subject} ‚Üí ${backendSubject}`);
            
            try {
                console.log(`üì§ G·ª≠i request ƒë·∫øn: ${BACKEND_CONFIG.url}/api/generate-questions`);
                
                const response = await fetch(`${BACKEND_CONFIG.url}/api/generate-questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        grade: parseInt(grade),
                        subject: backendSubject,
                        num: parseInt(num)
                    })
                });
                
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('üìä Server response:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Server returned error');
                }
                
                if (!data.questions || data.questions.length === 0) {
                    throw new Error('Server returned empty questions array');
                }
                
                console.log(`‚úÖ Nh·∫≠n ƒë∆∞·ª£c ${data.questions.length} c√¢u h·ªèi t·ª´ AI`);
                console.log('üìù C√¢u h·ªèi ƒë·∫ßu ti√™n:', data.questions[0]);
                
                return data.questions;
                
            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫°o c√¢u h·ªèi:', error.message);
                console.log('üîÑ Chuy·ªÉn sang d√πng c√¢u h·ªèi m·∫∑c ƒë·ªãnh');
                
                // Fallback to default questions
                const defaultQuestions = getDefaultQuestions(grade, subject);
                console.log(`üìù S·ª≠ d·ª•ng ${defaultQuestions.length} c√¢u h·ªèi m·∫∑c ƒë·ªãnh`);
                return defaultQuestions;
            }
        }

        // ========== LOADING UI FUNCTIONS ==========
        
        function showAIQuestionLoading(grade, subject) {
            // X√≥a loading c≈© n·∫øu c√≥
            const oldLoading = document.getElementById('aiQuestionLoading');
            if (oldLoading) oldLoading.remove();
            
            const loadingEl = document.createElement('div');
            loadingEl.id = 'aiQuestionLoading';
            
            const subjectText = subject === 'all' ? 'T·∫•t c·∫£ m√¥n h·ªçc' : `M√¥n ${subject}`;
            
            loadingEl.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                           background: rgba(0,0,0,0.95); display: flex; flex-direction: column; 
                           justify-content: center; align-items: center; z-index: 10000;
                           font-family: 'Inter', sans-serif;">
                    
                    <div style="text-align: center; max-width: 500px; padding: 20px;">
                        <!-- Logo/Icon -->
                        <div style="font-size: 4rem; margin-bottom: 20px; animation: float 3s ease-in-out infinite;">
                            ü§ñ
                        </div>
                        
                        <!-- Title -->
                        <h1 style="color: #ffffff; font-size: 2rem; font-weight: 900; margin-bottom: 10px;">
                            AI ƒêANG T·∫†O C√ÇU H·ªéI
                        </h1>
                        
                        <!-- Info -->
                        <div style="color: #a78bfa; font-size: 1.2rem; margin-bottom: 30px;">
                            <span style="background: rgba(167, 139, 250, 0.2); padding: 5px 15px; border-radius: 20px;">
                                üéì L·ªõp ${grade} ‚Ä¢ ${subjectText}
                            </span>
                        </div>
                        
                        <!-- Progress bar -->
                        <div style="width: 300px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 30px; overflow: hidden;">
                            <div id="aiLoadingBar" style="height: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 4px; width: 0%; 
                                    animation: pulse 2s ease-in-out infinite;"></div>
                        </div>
                        
                        <!-- Status messages -->
                        <div style="color: #d1d5db; font-size: 1rem; margin-bottom: 10px; min-height: 24px;">
                            <span id="aiStatusText">ƒêang k·∫øt n·ªëi v·ªõi AI Server...</span>
                        </div>
                        
                        <!-- Tips -->
                        <div style="color: #9ca3af; font-size: 0.9rem; margin-top: 20px; padding: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <span style="color: #60a5fa;">üí°</span>
                                <span id="aiLoadingTip">Vui l√≤ng ch·ªù trong gi√¢y l√°t...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loadingEl);
            
            // Animation
            let progress = 0;
            const bar = document.getElementById('aiLoadingBar');
            const statusText = document.getElementById('aiStatusText');
            const tipText = document.getElementById('aiLoadingTip');
            
            const steps = [
                'ƒêang k·∫øt n·ªëi v·ªõi AI Server...',
                'G·ª≠i y√™u c·∫ßu t·∫°o c√¢u h·ªèi...',
                'AI ƒëang ph√¢n t√≠ch ch∆∞∆°ng tr√¨nh h·ªçc...',
                'So·∫°n c√¢u h·ªèi ph√π h·ª£p...',
                'Ki·ªÉm tra ch·∫•t l∆∞·ª£ng c√¢u h·ªèi...',
                'Ho√†n t·∫•t...'
            ];
            
            const tips = [
                'AI ƒëang s·ª≠ d·ª•ng m√¥ h√¨nh Llama 3 70B...',
                'C√¢u h·ªèi ƒë∆∞·ª£c t·∫°o ri√™ng cho l·ªõp h·ªçc c·ªßa b·∫°n...',
                'ƒê·∫£m b·∫£o ph√π h·ª£p v·ªõi ch∆∞∆°ng tr√¨nh SGK...',
                'Ki·ªÉm tra ƒë√°p √°n ch√≠nh x√°c...',
                'S·∫Øp xong r·ªìi, ƒë·ª£i ch√∫t nh√©!'
            ];
            
            let stepIndex = 0;
            const interval = setInterval(() => {
                progress = Math.min(progress + 1.5, 95);
                if (bar) bar.style.width = progress + '%';
                
                // C·∫≠p nh·∫≠t status m·ªói 15%
                if (progress % 15 === 0 && stepIndex < steps.length - 1) {
                    stepIndex++;
                    if (statusText) statusText.textContent = steps[stepIndex];
                    
                    // C·∫≠p nh·∫≠t tip ng·∫´u nhi√™n
                    if (tipText && Math.random() > 0.7) {
                        tipText.textContent = tips[Math.floor(Math.random() * tips.length)];
                    }
                }
            }, 200);
            
            // L∆∞u interval ƒë·ªÉ clear sau
            loadingEl.dataset.interval = interval;
            
            // CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes float {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-10px); }
                }
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
            `;
            document.head.appendChild(style);
        }
        
        function hideAIQuestionLoading() {
            const loadingEl = document.getElementById('aiQuestionLoading');
            if (loadingEl) {
                // Clear interval
                if (loadingEl.dataset.interval) {
                    clearInterval(parseInt(loadingEl.dataset.interval));
                }
                
                // Animation fade out
                loadingEl.style.transition = 'opacity 0.5s ease';
                loadingEl.style.opacity = '0';
                
                setTimeout(() => {
                    if (loadingEl.parentNode) {
                        loadingEl.parentNode.removeChild(loadingEl);
                    }
                }, 500);
            }
        }
        
        function showBackendSuccess(count, grade, subject) {
            const effectArea = document.getElementById('effect-area');
            if (!effectArea) return;
            
            // T·∫°o hi·ªáu ·ª©ng ch√≠nh
            const successEl = document.createElement('div');
            successEl.innerHTML = `
                <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
                           text-align: center; z-index: 100;">
                    <div style="font-size: 4rem; margin-bottom: 10px; animation: popIn 0.5s ease-out;">
                        üéâ
                    </div>
                    <div style="color: #10b981; font-size: 2rem; font-weight: 900; margin-bottom: 5px;
                               text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);">
                        TH√ÄNH C√îNG!
                    </div>
                    <div style="color: #ffffff; font-size: 1.2rem; background: rgba(16, 185, 129, 0.2);
                               padding: 10px 20px; border-radius: 20px; margin: 10px 0;">
                        ƒê√£ t·∫°o ${count} c√¢u h·ªèi AI
                    </div>
                    <div style="color: #d1d5db; font-size: 0.9rem; margin-top: 5px;">
                        L·ªõp ${grade} ‚Ä¢ ${subject === 'all' ? 'T·∫•t c·∫£ m√¥n' : 'M√¥n ' + subject}
                    </div>
                </div>
            `;
            successEl.className = 'score-plus-effect';
            successEl.style.position = 'absolute';
            successEl.style.width = '100%';
            successEl.style.height = '100%';
            
            effectArea.appendChild(successEl);
            
            // Th√™m confetti
            createMiniConfetti(effectArea);
            
            // Auto remove
            setTimeout(() => {
                if (successEl.parentNode) {
                    successEl.parentNode.removeChild(successEl);
                }
            }, 3000);
        }
        
        function showBackendError(message) {
            const effectArea = document.getElementById('effect-area');
            if (!effectArea) return;
            
            const errorEl = document.createElement('div');
            errorEl.innerHTML = `
                <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
                           text-align: center; z-index: 100; background: rgba(239, 68, 68, 0.2);
                           padding: 20px; border-radius: 15px; backdrop-filter: blur(10px);">
                    <div style="font-size: 3rem; margin-bottom: 10px;">
                        ‚ö†Ô∏è
                    </div>
                    <div style="color: #f87171; font-size: 1.5rem; font-weight: 900; margin-bottom: 10px;">
                        KH√îNG TH·ªÇ K·∫æT N·ªêI AI
                    </div>
                    <div style="color: #fca5a5; font-size: 1rem; max-width: 300px;">
                        ${message}
                    </div>
                    <div style="color: #94a3b8; font-size: 0.8rem; margin-top: 15px; padding-top: 10px;
                               border-top: 1px solid rgba(248, 113, 113, 0.3);">
                        ‚ö° S·∫Ω d√πng c√¢u h·ªèi m·∫∑c ƒë·ªãnh
                    </div>
                </div>
            `;
            errorEl.className = 'score-plus-effect';
            errorEl.style.position = 'absolute';
            errorEl.style.width = '100%';
            errorEl.style.height = '100%';
            
            effectArea.appendChild(errorEl);
            
            setTimeout(() => {
                if (errorEl.parentNode) {
                    errorEl.parentNode.removeChild(errorEl);
                }
            }, 4000);
        }
        
        function createMiniConfetti(container) {
            const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b'];
            
            for (let i = 0; i < 15; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = `${8 + Math.random() * 10}px`;
                confetti.style.height = `${8 + Math.random() * 10}px`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = `${Math.random() * 100}%`;
                confetti.style.opacity = '0';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                // Animation
                confetti.style.animation = `
                    confettiFall 1.5s ease-out ${i * 0.1}s forwards,
                    fadeOut 1s ease-in ${0.5 + i * 0.1}s forwards
                `;
                
                container.appendChild(confetti);
                
                // Auto remove
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 2000);
            }
            
            // Th√™m CSS animation
            if (!document.getElementById('confettiStyle')) {
                const style = document.createElement('style');
                style.id = 'confettiStyle';
                style.textContent = `
                    @keyframes confettiFall {
                        0% { 
                            transform: translateY(-100px) rotate(0deg); 
                            opacity: 1; 
                        }
                        100% { 
                            transform: translateY(300px) rotate(360deg); 
                            opacity: 0.5;
                        }
                    }
                    @keyframes fadeOut {
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ========== NEW SETTINGS FUNCTIONS - ƒê√É S·ª¨A THI·∫æT K·∫æ ==========
        function toggleExplanations(enabled) {
            settings.showExplanations = enabled;
            // UI ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi toggle-switch, kh√¥ng c·∫ßn c·∫≠p nh·∫≠t th√™m
        }

        function toggleAutoContinue(enabled) {
            settings.autoContinue = enabled;
            // UI ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi toggle-switch, kh√¥ng c·∫ßn c·∫≠p nh·∫≠t th√™m
            
            // Show/hide indicator
            const indicator = document.getElementById('autoContinueIndicator');
            if (indicator) {
                indicator.style.display = enabled ? 'flex' : 'none';
            }
        }

        // ========== UPDATED STATS FUNCTIONS ==========
        function showStats() {
            const userInfo = auth.getUserInfo();
            if (!userInfo) return;
            
            const detailedStats = auth.getDetailedStats();
            const assessment = auth.getSkillAssessment();
            
            // Update basic stats
            document.getElementById('totalGames').textContent = detailedStats.basic.gamesPlayed;
            document.getElementById('bestScore').textContent = detailedStats.basic.bestScore;
            document.getElementById('questionsAnswered').textContent = detailedStats.basic.questionsAnswered;
            document.getElementById('accuracy').textContent = `${detailedStats.basic.accuracy}%`;
            
            // Build assessment section
            let assessmentHTML = '';
            if (assessment) {
                const gradeClass = getAssessmentGradeClass(assessment.overall);
                const gradeText = getAssessmentGradeText(assessment.overall);
                
                assessmentHTML = `
                    <div class="assessment-header">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-indigo-600">
                            <path fill-rule="evenodd" d="M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12a4.49 4.49 0 01-1.549 3.397 4.491 4.491 0 01-1.307 3.497 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.49 4.49 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                        </svg>
                        <h3 class="assessment-title">ƒê√ÅNH GI√Å NƒÇNG L·ª∞C</h3>
                    </div>
                    
                    <div class="assessment-grid">
                        <div class="assessment-item">
                            <p class="assessment-label">ƒêi·ªÉm t·ªïng th·ªÉ</p>
                            <p class="assessment-value ${gradeClass}">${assessment.overall}/100</p>
                            <p class="assessment-grade ${gradeClass}">${gradeText}</p>
                        </div>
                        <div class="assessment-item">
                            <p class="assessment-label">C·∫≠p nh·∫≠t l√∫c</p>
                            <p class="assessment-value text-gray-700">${new Date(assessment.lastUpdated).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</p>
                            <p class="assessment-grade text-gray-500">${new Date(assessment.lastUpdated).toLocaleDateString('vi-VN')}</p>
                        </div>
                    </div>
                `;
            }
            
            // Build subject stats section
            let subjectStatsHTML = '';
            if (detailedStats.subjects && Object.keys(detailedStats.subjects).length > 0) {
                subjectStatsHTML = `
                    <div class="mt-6">
                        <h4 class="font-bold text-lg text-gray-700 mb-3 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path d="M11.7 2.805a.75.75 0 01.6 0A60.65 60.65 0 0122.83 8.72a.75.75 0 01-.231 1.337 49.949 49.949 0 00-9.902 3.912l-.003.002-.34.18a.75.75 0 01-.707 0A50.009 50.009 0 007.5 12.174v-.224c0-.131.067-.248.172-.311a54.614 54.614 0 014.653-2.52.75.75 0 00-.65-1.352 56.129 56.129 0 00-4.78 2.589 1.858 1.858 0 00-.859 1.228 49.803 49.803 0 00-4.634-1.527.75.75 0 01-.231-1.337A60.653 60.653 0 0111.7 2.805z" />
                                <path d="M13.06 15.473a48.45 48.45 0 017.666-3.282c.134 1.414.22 2.843.255 4.285a.75.75 0 01-.46.71 47.878 47.878 0 00-8.105 4.342.75.75 0 01-.832 0 47.877 47.877 0 00-8.104-4.342.75.75 0 01-.461-.71c.035-1.442.121-2.87.255-4.286A48.4 48.4 0 016 13.18v1.27a1.5 1.5 0 00-.14 2.508c-.09.38-.222.753-.397 1.11.452.213.901.434 1.346.661a6.729 6.729 0 00.551-1.608 1.5 1.5 0 00.14-2.67v-.645a48.549 48.549 0 013.44 1.668 2.25 2.25 0 002.12 0z" />
                                <path d="M4.462 19.462c.42-.419.753-.89.99-1.394.237.504.569.975.99 1.394-.193.193-.4.38-.618.552.218.172.425.359.618.552-.42.419-.753.89-.99 1.394-.237-.504-.57-.975-.99-1.394a7.969 7.969 0 01.618-.552 7.969 7.969 0 01-.618-.552z" />
                            </svg>
                            TH·ªêNG K√ä THEO M√îN H·ªåC
                        </h4>
                        <div class="subject-progress space-y-4">
                `;
                
                Object.entries(detailedStats.subjects).forEach(([subject, stats]) => {
                    if (stats.total > 0) {
                        const percentage = Math.round((stats.correct / stats.total) * 100);
                        const barClass = getAssessmentGradeClass(percentage);
                        
                        subjectStatsHTML += `
                            <div class="subject-item-progress">
                                <div class="subject-name">
                                    <span>${subject}</span>
                                    <span class="subject-percentage ${barClass}">${percentage}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill ${barClass.replace('text-', 'bg-')}" 
                                         style="width: ${percentage}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${stats.correct} ƒë√∫ng / ${stats.total} c√¢u
                                </div>
                            </div>
                        `;
                    }
                });
                
                subjectStatsHTML += `
                        </div>
                    </div>
                `;
            }
            
            // Update modal
            document.getElementById('assessmentSection').innerHTML = assessmentHTML;
            document.getElementById('subjectStatsSection').innerHTML = subjectStatsHTML;
            
            // Show modal
            document.getElementById('userDropdown').classList.add('hidden');
            document.getElementById('mainMenuUserDropdown').classList.add('hidden');
            document.getElementById('statsModal').style.display = 'flex';
        }

        function getAssessmentGradeClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 80) return 'score-good';
            if (score >= 70) return 'score-average';
            if (score >= 50) return 'score-average';
            return 'score-need-improvement';
        }

        function getAssessmentGradeText(score) {
            if (score >= 90) return 'Xu·∫•t s·∫Øc';
            if (score >= 80) return 'Gi·ªèi';
            if (score >= 70) return 'Kh√°';
            if (score >= 50) return 'Trung b√¨nh';
            return 'C·∫ßn c·ªë g·∫Øng';
        }

        // ========== MENU FUNCTIONS ==========
        function loadSettings() {
            const saved = localStorage.getItem('flappyBrainSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(settings, parsed);
                console.log('Loaded settings:', settings);
            }
            updateAllSettingsUI();
            updateLanguageTexts();
            
            // Update auto continue indicator
            toggleAutoContinue(settings.autoContinue);
        }

        function updateAllSettingsUI() {
            document.querySelectorAll('.color-option').forEach((opt, index) => {
                opt.classList.toggle('active', index === settings.currentBgColor);
            });
            
            document.getElementById('gameSpeedSlider').value = settings.gameSpeed * 100;
            document.getElementById('speedValue').textContent = `${Math.round(settings.gameSpeed * 100)}%`;
            
            document.getElementById('soundToggle').checked = settings.soundEnabled;
            
            document.getElementById('volumeSlider').value = settings.volume * 100;
            document.getElementById('volumeValue').textContent = `${Math.round(settings.volume * 100)}%`;
            
            document.querySelectorAll('.lang-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-button[onclick*="${settings.language}"]`).classList.add('active');
            
            document.querySelectorAll('.lang-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-button[onclick*="${settings.difficulty}"]`).classList.add('active');
            
            document.getElementById('touchToggle').checked = settings.touchControl;
            
            // Load API key
            document.getElementById('groqApiKey').value = settings.groqApiKey || '';
            
            // Load new settings - THI·∫æT K·∫æ GI·ªêNG PH·∫¶N KI·ªÇM SO√ÅT
            document.getElementById('showExplanationsToggle').checked = settings.showExplanations;
            document.getElementById('autoContinueToggle').checked = settings.autoContinue;
        }

        function selectBgColor(index) {
            settings.currentBgColor = index;
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
            event.target.classList.add('active');
            applyBgColor();
        }

        function selectBirdColor(index) {
            settings.currentBirdColor = index;
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
            event.target.classList.add('active');
            applyBirdColor();
        }

        function updateGameSpeed(value) {
            settings.gameSpeed = value / 100;
            document.getElementById('speedValue').textContent = `${value}%`;
            if (game && gameState === 'play') {
                BASE_SPEED = 1.2 * settings.gameSpeed;
            }
        }

        function toggleSound(enabled) {
            settings.soundEnabled = enabled;
            Object.values(assets).forEach(asset => {
                if (asset instanceof Audio) {
                    asset.muted = !enabled;
                }
            });
        }

        function updateVolume(value) {
            settings.volume = value / 100;
            document.getElementById('volumeValue').textContent = `${value}%`;
            Object.values(assets).forEach(asset => {
                if (asset instanceof Audio) {
                    asset.volume = settings.volume;
                }
            });
        }

        function selectLanguage(lang) {
            settings.language = lang;
            document.querySelectorAll('.lang-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateLanguageTexts();
            saveSettings();
            
            // C·∫≠p nh·∫≠t l·∫°i ph·∫ßn ch·ªçn l·ªõp/m√¥n v·ªõi ng√¥n ng·ªØ m·ªõi
            setupGradeSubjectSelection();
            updateSelectedInfo();
        }

        function selectDifficulty(diff) {
            settings.difficulty = diff;
            document.querySelectorAll('.lang-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            applyDifficulty();
        }

        function toggleTouchControl(enabled) {
            settings.touchControl = enabled;
        }

        function saveSettings() {
            // L∆∞u API key
            settings.groqApiKey = document.getElementById('groqApiKey').value.trim();
            
            // L∆∞u c√°c setting m·ªõi
            settings.showExplanations = document.getElementById('showExplanationsToggle').checked;
            settings.autoContinue = document.getElementById('autoContinueToggle').checked;
            
            localStorage.setItem('flappyBrainSettings', JSON.stringify(settings));
            applyAllSettings();
            saveUserSettings();
            
            const effectArea = document.getElementById('effect-area');
            const e = document.createElement('div');
            e.textContent = settings.language === 'vi' ? 'ƒê√£ l∆∞u c√†i ƒë·∫∑t!' : 'Settings saved!';
            e.className = 'score-plus-effect';
            e.style.left = '50%';
            e.style.top = '50%';
            e.style.color = '#4ade80';
            effectArea.appendChild(e);
            setTimeout(() => e.remove(), 1500);
            
            hideSettingsModal();
        }

        function resetSettings() {
            settings.currentBgColor = 0;
            settings.currentBirdColor = 0;
            settings.gameSpeed = 1.0;
            settings.soundEnabled = true;
            settings.volume = 0.8;
            settings.language = 'vi';
            settings.difficulty = 'easy';
            settings.touchControl = true;
            settings.groqApiKey = '';
            settings.showExplanations = true;
            settings.autoContinue = false;
            
            updateAllSettingsUI();
            applyAllSettings();
            updateLanguageTexts();
            
            // C·∫≠p nh·∫≠t l·∫°i ph·∫ßn ch·ªçn l·ªõp/m√¥n
            setupGradeSubjectSelection();
            updateSelectedInfo();
            
            const effectArea = document.getElementById('effect-area');
            const e = document.createElement('div');
            e.textContent = settings.language === 'vi' ? 'ƒê√£ ƒë·∫∑t l·∫°i!' : 'Reset complete!';
            e.className = 'score-plus-effect';
            e.style.left = '50%';
            e.style.top = '50%';
            e.style.color = '#f5576c';
            effectArea.appendChild(e);
            setTimeout(() => e.remove(), 1500);
        }

        function applyAllSettings() {
            applyBgColor();
            applyBirdColor();
            toggleSound(settings.soundEnabled);
            updateVolume(settings.volume * 100);
            applyDifficulty();
        }

        function applyBgColor() {
            console.log('Background color setting ignored - using pixel art background image');
        }

        function applyBirdColor() {
            console.log('Bird color setting ignored - using pixel art bird sprites');
        }

        function updateLanguageTexts() {
            const lang = settings.language;
            const t = texts[lang];
            
            // Menu ch√≠nh
            document.getElementById('menuSubtitle').textContent = t.menuSubtitle;
            document.getElementById('gradeLabel').textContent = t.gradeLabel;
            document.getElementById('subjectLabel').textContent = t.subjectLabel;
            document.getElementById('startGameText').textContent = t.startGame;
            document.getElementById('testBackendText').textContent = 'üîó KI·ªÇM TRA SERVER';
            document.getElementById('settingsText').textContent = t.settings;
            document.getElementById('guideText').textContent = t.guide;
            document.getElementById('aboutText').textContent = t.about;
            
            // C√†i ƒë·∫∑t
            document.getElementById('settingsTitle').textContent = t.settingsTitle;
            document.getElementById('aiApiKeyLabel').textContent = t.aiApiKeyLabel;
            document.getElementById('apiKeyHelp').innerHTML = t.apiKeyHelp.replace('console.groq.com', '<a href="https://console.groq.com/keys" target="_blank" class="text-blue-400 underline">console.groq.com</a>');
            document.getElementById('bgColorLabel').textContent = t.bgColorLabel;
            document.getElementById('birdColorLabel').textContent = t.birdColorLabel;
            document.getElementById('gameSpeedLabel').textContent = t.gameSpeedLabel;
            document.getElementById('slowText').textContent = t.slow;
            document.getElementById('fastText').textContent = t.fast;
            document.getElementById('soundLabel').textContent = t.soundLabel;
            document.getElementById('soundToggleText').textContent = t.soundToggle;
            document.getElementById('volumeLabel').textContent = t.volumeLabel;
            document.getElementById('lowText').textContent = t.low;
            document.getElementById('highText').textContent = t.high;
            document.getElementById('languageLabel').textContent = t.languageLabel;
            document.getElementById('difficultyLabel').textContent = t.difficultyLabel;
            document.getElementById('easyBtn').textContent = t.easy;
            document.getElementById('mediumBtn').textContent = t.medium;
            document.getElementById('hardBtn').textContent = t.hard;
            document.getElementById('controlLabel').textContent = t.controlLabel;
            document.getElementById('touchControlText').textContent = t.touchControl;
            
            // New settings texts - THI·∫æT K·∫æ GI·ªêNG PH·∫¶N KI·ªÇM SO√ÅT
            document.getElementById('explanationLabel').textContent = t.explanationLabel;
            document.getElementById('explanationToggleText').textContent = t.explanationToggleText;
            document.getElementById('autoContinueLabel').textContent = t.autoContinueLabel;
            document.getElementById('autoContinueToggleText').textContent = t.autoContinueToggleText;
            
            document.getElementById('saveText').textContent = t.save;
            document.getElementById('resetText').textContent = t.reset;
            document.getElementById('closeText').textContent = t.close;
            
            // Question modal
            document.getElementById('hintText').textContent = t.hint;
            document.getElementById('warningText').textContent = t.warning;
            document.getElementById('warningMessage').textContent = t.warningMessage;
            
            // New game texts
            document.getElementById('continueGameText').textContent = t.continueGame;
            document.getElementById('explanationTitle').textContent = t.explanationTitle;
            document.getElementById('closeExplanationText').textContent = t.closeExplanation;
            document.getElementById('explanationLoadingText').textContent = t.aiExplanation;
            document.getElementById('autoContinueText').textContent = t.autoContinueText;
            
            // Win modal
            document.getElementById('winTitle').textContent = t.winTitle;
            document.getElementById('winScoreLabel').textContent = t.winScore;
            document.getElementById('winQuestionsLabel').textContent = t.winQuestions;
            document.getElementById('winBestLabel').textContent = t.winBest;
            document.getElementById('homeText').textContent = t.home;
            document.getElementById('playAgainText').textContent = t.playAgain;
            
            // Modal
            document.getElementById('closeModalBtn').textContent = t.closeModal;
            
            // Auth texts
            document.getElementById('loginTabText').textContent = t.loginTab;
            document.getElementById('registerTabText').textContent = t.registerTab;
            document.getElementById('loginUsernameLabel').textContent = t.loginUsername;
            document.getElementById('loginPasswordLabel').textContent = t.loginPassword;
            document.getElementById('loginButton').textContent = t.loginButton;
            document.getElementById('switchToRegisterText').innerHTML = t.switchToRegister.replace('ƒêƒÉng k√Ω ngay', '<a href="javascript:void(0)" onclick="switchAuthTab(\'register\')" class="text-purple-400 font-bold">' + (lang === 'vi' ? 'ƒêƒÉng k√Ω ngay' : 'Register now') + '</a>');
            document.getElementById('registerUsernameLabel').textContent = t.registerUsername;
            document.getElementById('usernameHelpText').textContent = t.usernameHelp;
            document.getElementById('registerPasswordLabel').textContent = t.registerPassword;
            document.getElementById('confirmPasswordLabel').textContent = t.confirmPassword;
            document.getElementById('birthDateLabel').textContent = t.birthDate;
            document.getElementById('genderLabel').textContent = t.gender;
            document.getElementById('genderMaleText').textContent = t.genderMale;
            document.getElementById('genderFemaleText').textContent = t.genderFemale;
            document.getElementById('genderOtherText').textContent = t.genderOther;
            document.getElementById('registerButton').textContent = t.registerButton;
            document.getElementById('switchToLoginText').innerHTML = t.switchToLogin.replace('ƒêƒÉng nh·∫≠p', '<a href="javascript:void(0)" onclick="switchAuthTab(\'login\')" class="text-purple-400 font-bold">' + (lang === 'vi' ? 'ƒêƒÉng nh·∫≠p' : 'Login') + '</a>');
            
            // User dropdown texts
            document.getElementById('profileText').textContent = t.profile;
            document.getElementById('statsText').textContent = t.stats;
            document.getElementById('logoutText').textContent = t.logout;
            
            // Main menu user dropdown texts
            document.getElementById('mainMenuProfileText').textContent = t.profile;
            document.getElementById('mainMenuStatsText').textContent = t.stats;
            document.getElementById('mainMenuLogoutText').textContent = t.logout;
            
            // Profile modal texts
            document.getElementById('profileTitle').textContent = t.profileTitle;
            document.getElementById('closeProfileText').textContent = t.closeProfile;
            
            // Stats modal texts
            document.getElementById('statsTitle').textContent = t.statsTitle;
            document.getElementById('totalGamesText').textContent = t.totalGames;
            document.getElementById('bestScoreText').textContent = t.bestScore;
            document.getElementById('questionsAnsweredText').textContent = t.questionsAnswered;
            document.getElementById('accuracyText').textContent = t.accuracy;
            document.getElementById('closeStatsText').textContent = t.closeStats;
            
            // C·∫≠p nh·∫≠t nh√£n l·ªõp h·ªçc
            const grades = [6, 7, 8, 9, 10, 11, 12];
            grades.forEach(grade => {
                const gradeLabel = document.getElementById(`gradeLabel${grade}`);
                if (gradeLabel) {
                    gradeLabel.textContent = t[`grade${grade}`] || `L·ªõp ${grade}`;
                }
            });
            
            // C·∫≠p nh·∫≠t t√™n m√¥n h·ªçc
            const subjects = [
                { id: 'all', element: document.querySelector('.subject-item[data-subject="all"] .subject-name') },
                { id: 'To√°n', element: document.querySelector('.subject-item[data-subject="To√°n"] .subject-name') },
                { id: 'L√Ω', element: document.querySelector('.subject-item[data-subject="L√Ω"] .subject-name') },
                { id: 'H√≥a', element: document.querySelector('.subject-item[data-subject="H√≥a"] .subject-name') },
                { id: 'Sinh', element: document.querySelector('.subject-item[data-subject="Sinh"] .subject-name') },
                { id: 'VƒÉn', element: document.querySelector('.subject-item[data-subject="VƒÉn"] .subject-name') },
                { id: 'Anh', element: document.querySelector('.subject-item[data-subject="Anh"] .subject-name') },
                { id: 'S·ª≠', element: document.querySelector('.subject-item[data-subject="S·ª≠"] .subject-name') },
                { id: 'ƒê·ªãa', element: document.querySelector('.subject-item[data-subject="ƒê·ªãa"] .subject-name') }
            ];
            
            subjects.forEach(subject => {
                if (subject.element) {
                    if (subject.id === 'all') {
                        subject.element.textContent = t.allSubjects;
                    } else {
                        // Gi·ªØ nguy√™n t√™n m√¥n ti·∫øng Vi·ªát
                        const subjectNames = {
                            'To√°n': 'To√°n',
                            'L√Ω': 'V·∫≠t L√Ω',
                            'H√≥a': 'H√≥a H·ªçc',
                            'Sinh': 'Sinh H·ªçc',
                            'VƒÉn': 'Ng·ªØ VƒÉn',
                            'Anh': 'Ti·∫øng Anh',
                            'S·ª≠': 'L·ªãch S·ª≠',
                            'ƒê·ªãa': 'ƒê·ªãa L√Ω'
                        };
                        subject.element.textContent = lang === 'vi' ? 
                            subjectNames[subject.id] : subject.id;
                    }
                }
            });
            
            // C·∫≠p nh·∫≠t th√¥ng tin ƒë√£ ch·ªçn
            updateSelectedInfo();
        }

        function applyDifficulty() {
            switch(settings.difficulty) {
                case 'easy':
                    PIPE_GAP = 140;
                    BASE_SPEED = 1.0;
                    break;
                case 'medium':
                    PIPE_GAP = 130;
                    BASE_SPEED = 1.2;
                    break;
                case 'hard':
                    PIPE_GAP = 120;
                    BASE_SPEED = 1.5;
                    break;
            }
        }

        // ========== H√ÄM HI·ªÇN TH·ªä MODAL ==========
        function showInfo() {
            const t = texts[settings.language];
            document.getElementById('modalTitle').textContent = t.guide.replace('üìñ ', '');
            
            if (settings.language === 'vi') {
                document.getElementById('modalBody').innerHTML = `
                    <h3>üéÆ C√°ch ch∆°i:</h3>
                    <ul>
                        <li>Nh·∫•n v√†o m√†n h√¨nh ho·∫∑c ph√≠m Space ƒë·ªÉ chim bay l√™n</li>
                        <li>Tr√°nh ch·∫°m v√†o ·ªëng v√† m·∫∑t ƒë·∫•t</li>
                        <li>Bay qua ·ªëng ƒë·ªÉ ghi ƒëi·ªÉm</li>
                    </ul>

                    <h3>‚ùì C√¢u h·ªèi:</h3>
                    <ul>
                        <li>Sau m·ªói 5 ·ªëng, b·∫°n s·∫Ω g·∫∑p c√¢u h·ªèi tr·∫Øc nghi·ªám</li>
                        <li>Tr·∫£ l·ªùi ƒë√∫ng: +5 ƒëi·ªÉm v√† x√≥a 2 ·ªëng ph√≠a tr∆∞·ªõc</li>
                        <li>Tr·∫£ l·ªùi sai: Game Over ngay l·∫≠p t·ª©c!</li>
                    </ul>

                    <h3>üí° G·ª£i √Ω:</h3>
                    <ul>
                        <li>Nh·∫≠n 1 g·ª£i √Ω sau m·ªói 10 ƒëi·ªÉm</li>
                        <li>G·ª£i √Ω s·∫Ω lo·∫°i b·ªè 2 ƒë√°p √°n sai</li>
                        <li>S·ª≠ d·ª•ng th√¥ng minh ƒë·ªÉ v∆∞·ª£t qua th·ª≠ th√°ch!</li>
                    </ul>

                    <h3>ü§ñ T√≠nh nƒÉng m·ªõi:</h3>
                    <ul>
                        <li>Gi·∫£i th√≠ch AI: Nh·∫≠n gi·∫£i th√≠ch chi ti·∫øt cho c√¢u tr·∫£ l·ªùi sai</li>
                        <li>T·ª± ƒë·ªông ti·∫øp t·ª•c: Game t·ª± ƒë·ªông ti·∫øp t·ª•c sau khi tr·∫£ l·ªùi</li>
                        <li>ƒê√°nh gi√° nƒÉng l·ª±c: Xem ph√¢n t√≠ch chi ti·∫øt v·ªÅ k·ªπ nƒÉng c·ªßa b·∫°n</li>
                        <li>Progress bars: Theo d√µi ti·∫øn ƒë·ªô h·ªçc t·∫≠p theo m√¥n</li>
                    </ul>

                    <h3>üéØ Chi·∫øn th·∫Øng:</h3>
                    <ul>
                        <li>Ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi c·ªßa l·ªõp h·ªçc ƒë·ªÉ chi·∫øn th·∫Øng</li>
                        <li>Sau c√¢u h·ªèi cu·ªëi c√πng, game ti·∫øp t·ª•c 1 gi√¢y r·ªìi hi·ªán m√†n h√¨nh chi·∫øn th·∫Øng</li>
                    </ul>

                    <h3>‚è∏Ô∏è T·∫°m d·ª´ng:</h3>
                    <ul>
                        <li>Nh·∫•n n√∫t pause ·ªü g√≥c ph·∫£i ƒë·ªÉ t·∫°m d·ª´ng game</li>
                        <li>Nh·∫•n n√∫t "Ti·∫øp t·ª•c" ƒë·ªÉ quay l·∫°i game</li>
                    </ul>

                    <h3>ü§ñ AI T·∫°o C√¢u H·ªèi:</h3>
                    <ul>
                        <li>Nh·∫≠p Groq API Key trong Settings ƒë·ªÉ d√πng AI</li>
                        <li>AI s·∫Ω t·∫°o c√¢u h·ªèi theo l·ªõp v√† m√¥n h·ªçc b·∫°n ch·ªçn</li>
                        <li>Kh√¥ng c√≥ API key? Game s·∫Ω d√πng c√¢u h·ªèi m·∫∑c ƒë·ªãnh</li>
                    </ul>

                    <h3>üèÜ M·ª•c ti√™u:</h3>
                    <p>Ghi ƒëi·ªÉm cao nh·∫•t c√≥ th·ªÉ b·∫±ng c√°ch k·∫øt h·ª£p k·ªπ nƒÉng bay v√† ki·∫øn th·ª©c!</p>
                `;
            } else {
                document.getElementById('modalBody').innerHTML = `
                    <h3>üéÆ How to Play:</h3>
                    <ul>
                        <li>Tap the screen or press Space to make the bird fly up</li>
                        <li>Avoid hitting pipes and the ground</li>
                        <li>Fly through pipes to score points</li>
                    </ul>

                    <h3>‚ùì Questions:</h3>
                    <ul>
                        <li>After every 5 pipes, you'll encounter a multiple-choice question</li>
                        <li>Correct answer: +5 points and remove 2 pipes ahead</li>
                        <li>Wrong answer: Game Over immediately!</li>
                    </ul>

                    <h3>üí° Hints:</h3>
                    <ul>
                        <li>Get 1 hint for every 10 points scored</li>
                        <li>Hint will eliminate 2 wrong answers</li>
                        <li>Use wisely to overcome challenges!</li>
                    </ul>

                    <h3>ü§ñ New Features:</h3>
                    <ul>
                        <li>AI Explanation: Get detailed explanations for wrong answers</li>
                        <li>Auto Continue: Game automatically continues after answering</li>
                        <li>Skill Assessment: View detailed analysis of your skills</li>
                        <li>Progress Bars: Track learning progress by subject</li>
                    </ul>

                    <h3>üéØ Victory:</h3>
                    <ul>
                        <li>Complete all questions for your grade to win</li>
                        <li>After the last question, game continues for 1 second then shows victory screen</li>
                    </ul>

                    <h3>‚è∏Ô∏è Pause:</h3>
                    <ul>
                        <li>Press the pause button at top right to pause the game</li>
                        <li>Press "Continue" button to resume playing</li>
                    </ul>

                    <h3>ü§ñ AI Question Generation:</h3>
                    <ul>
                        <li>Enter Groq API Key in Settings to use AI</li>
                        <li>AI will create questions based on selected grade and subject</li>
                        <li>No API key? Game will use default questions</li>
                    </ul>

                    <h3>üèÜ Goal:</h3>
                    <p>Achieve the highest score by combining flying skills and knowledge!</p>
                `;
            }
            document.getElementById('infoModal').style.display = 'flex';
        }

        function showAbout() {
            const t = texts[settings.language];
            document.getElementById('modalTitle').textContent = t.about.replace('‚ÑπÔ∏è ', '');
            
            if (settings.language === 'vi') {
                document.getElementById('modalBody').innerHTML = `
                    <h3>üß† Flappy Brain - Game Tr√≠ Tu·ªá & Ph·∫£n X·∫°</h3>
                    <p>Phi√™n b·∫£n ƒë·∫∑c bi·ªát k·∫øt h·ª£p gi·ªØa game Flappy Bird kinh ƒëi·ªÉn v√† h·ªá th·ªëng c√¢u h·ªèi tr·∫Øc nghi·ªám ƒëa m√¥n h·ªçc!</p>
                    
                    <h3>‚ú® ƒê·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t:</h3>
                    <ul>
                        <li>üéÆ Gameplay ƒë∆°n gi·∫£n nh∆∞ng c·ª±c k·ª≥ th·ª≠ th√°ch</li>
                        <li>ü§ñ H·ªá th·ªëng AI t·∫°o c√¢u h·ªèi th√¥ng minh (Groq API)</li>
                        <li>üìö C√¢u h·ªèi ƒëa d·∫°ng t·ª´ To√°n, L√Ω, H√≥a, Sinh, VƒÉn, Anh, S·ª≠, ƒê·ªãa</li>
                        <li>üè´ Ph√¢n lo·∫°i theo l·ªõp h·ªçc: 6, 7, 8, 9, 10, 11, 12</li>
                        <li>üéØ Ch·ªçn m√¥n h·ªçc chi ti·∫øt v·ªõi l·ªõp 10-12</li>
                        <li>‚öôÔ∏è H·ªá th·ªëng c√†i ƒë·∫∑t to√†n di·ªán</li>
                        <li>üí° H·ªá th·ªëng g·ª£i √Ω th√¥ng minh</li>
                        <li>üåê H·ªó tr·ª£ ƒëa ng√¥n ng·ªØ: Ti·∫øng Vi·ªát & Ti·∫øng Anh</li>
                        <li>ü§ñ Gi·∫£i th√≠ch AI cho c√¢u tr·∫£ l·ªùi sai</li>
                        <li>‚ö° T·ª± ƒë·ªông ti·∫øp t·ª•c game</li>
                        <li>üìä ƒê√°nh gi√° nƒÉng l·ª±c chi ti·∫øt</li>
                        <li>üìà Progress bars theo d√µi ti·∫øn ƒë·ªô</li>
                    </ul>

                    <h3>üë®‚Äçüíª T√°c gi·∫£ & Ph√°t tri·ªÉn:</h3>
                    <p style="text-align: center; font-weight: bold; color: #764ba2; font-size: 1.3rem;">
                        <span style="color: #667eea;">A1K64</span> - ƒêo√†n k·∫øt t·∫°o n√™n th∆∞∆°ng hi·ªáu
                    </p>
                    
                    <h3>üéØ M·ª•c ti√™u gi√°o d·ª•c:</h3>
                    <ul>
                        <li>K·∫øt h·ª£p gi·∫£i tr√≠ v√† h·ªçc t·∫≠p m·ªôt c√°ch t·ª± nhi√™n</li>
                        <li>R√®n luy·ªán ph·∫£n x·∫° nhanh v√† t∆∞ duy logic</li>
                        <li>√în t·∫≠p ki·∫øn th·ª©c ƒëa m√¥n h·ªçc theo ch∆∞∆°ng tr√¨nh ph·ªï th√¥ng</li>
                        <li>Ph√¢n t√≠ch v√† c·∫£i thi·ªán k·ªπ nƒÉng h·ªçc t·∫≠p th√¥ng qua ƒë√°nh gi√° chi ti·∫øt</li>
                    </ul>

                    <p style="text-align: center; margin-top: 1.5rem; color: #667eea; font-style: italic;">
                        "H·ªçc m√† ch∆°i, ch∆°i m√† h·ªçc - Tr√≠ tu·ªá v√† ph·∫£n x·∫° c√πng ph√°t tri·ªÉn!"
                    </p>

                    <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee;">
                        <p style="font-size: 0.9rem; color: #666;">
                            ¬© 2026 A1K64. All rights reserved.<br>
                            Game ƒë∆∞·ª£c ph√°t tri·ªÉn v·ªõi m·ª•c ƒë√≠ch gi√°o d·ª•c v√† gi·∫£i tr√≠ l√†nh m·∫°nh.
                        </p>
                    </div>
                `;
            } else {
                document.getElementById('modalBody').innerHTML = `
                    <h3>üß† Flappy Brain - Intelligence & Reflex Game</h3>
                    <p>Special edition combining classic Flappy Bird gameplay with multi-subject quiz system!</p>
                    
                    <h3>‚ú® Key Features:</h3>
                    <ul>
                        <li>üéÆ Simple yet challenging gameplay</li>
                        <li>ü§ñ AI-powered question generation (Groq API)</li>
                        <li>üìö Diverse questions from Math, Physics, Chemistry, Biology, Literature, English, History, Geography</li>
                        <li>üè´ Organized by grade levels: 6, 7, 8, 9, 10, 11, 12</li>
                        <li>üéØ Detailed subject selection for grades 10-12</li>
                        <li>‚öôÔ∏è Comprehensive settings system</li>
                        <li>üí° Smart hint system</li>
                        <li>üåê Multi-language support: Vietnamese & English</li>
                        <li>ü§ñ AI explanations for wrong answers</li>
                        <li>‚ö° Auto continue game feature</li>
                        <li>üìä Detailed skill assessment</li>
                        <li>üìà Progress tracking with visual bars</li>
                    </ul>

                    <h3>üë®‚Äçüíª Author & Development:</h3>
                    <p style="text-align: center; font-weight: bold; color: #764ba2; font-size: 1.3rem;">
                        <span style="color: #667eea;">A1K64</span> - Independent Game Developer
                    </p>
                    
                    <h3>üéØ Educational Goals:</h3>
                    <ul>
                        <li>Combine entertainment and learning naturally</li>
                        <li>Train quick reflexes and logical thinking</li>
                        <li>Review multi-subject knowledge according to curriculum</li>
                        <li>Analyze and improve learning skills through detailed assessment</li>
                    </ul>

                    <p style="text-align: center; margin-top: 1.5rem; color: #667eea; font-style: italic;">
                        "Learn while playing, play while learning - Intelligence and reflexes develop together!"
                    </p>

                    <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee;">
                        <p style="font-size: 0.9rem; color: #666;">
                            ¬© 2026 A1K64. All rights reserved.<br>
                            Game developed for educational and wholesome entertainment purposes.
                        </p>
                    </div>
                `;
            }
            document.getElementById('infoModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // ========== C√ÅC H√ÄM GAME C∆† B·∫¢N ==========
        async function startGame() {
            console.log('üéÆ ========================================');
            console.log('üéÆ B·∫ÆT ƒê·∫¶U GAME V·ªöI AI BACKEND');
            console.log(`üéÆ L·ªõp: ${selectedGrade}, M√¥n: ${selectedSubject}`);
            console.log(`üéÆ Backend URL: ${BACKEND_CONFIG.url}`);
            console.log('üéÆ ========================================');
            
            if (!selectedGrade) {
                const t = texts[settings.language];
                alert(t.gradeLabel || 'Vui l√≤ng ch·ªçn l·ªõp h·ªçc tr∆∞·ªõc!');
                return;
            }
            
            // Hi·ªán loading
            const loadingEl = document.createElement('div');
            loadingEl.id = 'loadingOverlay';
            const t = texts[settings.language];
            loadingEl.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.9); display: flex; flex-direction: column; 
                        justify-content: center; align-items: center; z-index: 9999;">
                    <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-purple-500 mb-6"></div>
                    <p class="text-white text-xl font-bold mb-2">${t.generatingQuestions}</p>
                    <p class="text-gray-300 text-sm">${selectedSubject === 'all' ? 'T·∫•t c·∫£ m√¥n' : 'M√¥n ' + selectedSubject} - L·ªõp ${selectedGrade}</p>
                </div>
            `;
            document.body.appendChild(loadingEl);
            
            try {
                console.log('ü§ñ G·ªçi h√†m generateQuestions()...');
                const aiQuestions = await generateQuestions(selectedGrade, selectedSubject, 20);
                
                console.log(`‚úÖ Nh·∫≠n ƒë∆∞·ª£c ${aiQuestions.length} c√¢u h·ªèi t·ª´ backend`);
                console.log('üìù C√¢u h·ªèi ƒë·∫ßu ti√™n:', aiQuestions[0]);
                
                // ƒê·∫£m b·∫£o game ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o
                if (!game) {
                    console.error('‚ùå Game ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!');
                    loadingEl.remove();
                    return;
                }
                
                // QUAN TR·ªåNG: Reset game TR∆Ø·ªöC KHI g√°n c√¢u h·ªèi
                game.reset();
                
                // G√°n c√¢u h·ªèi AI v√†o game
                game.originalQuestions = [...aiQuestions];
                game.remainingQuestions = [...aiQuestions];
                
                console.log(`üéÆ Game ready v·ªõi ${game.originalQuestions.length} c√¢u h·ªèi AI`);
                console.log('üéØ C√¢u h·ªèi AI ƒë·∫ßu ti√™n:', game.originalQuestions[0]);
                
                // Reset game state
                gameState = 'ready';
                
                // Hi·ªáu ·ª©ng th√†nh c√¥ng
                const effectArea = document.getElementById('effect-area');
                if (effectArea) {
                    const e = document.createElement('div');
                    e.textContent = t.language === 'vi' ? 
                        `ƒê√£ t·∫°o ${aiQuestions.length} c√¢u h·ªèi AI!` : 
                        `Generated ${aiQuestions.length} AI questions!`;
                    e.className = 'score-plus-effect';
                    e.style.left = '50%';
                    e.style.top = '50%';
                    e.style.color = '#4ade80';
                    effectArea.appendChild(e);
                    setTimeout(() => e.remove(), 1500);
                }
                
                // ·∫®n loading
                setTimeout(() => {
                    loadingEl.remove();
                    
                    // Hi·ªán game UI
                    document.getElementById('mainMenu').style.display = 'none';
                    document.getElementById('jumpButton').style.display = 'flex';
                    document.getElementById('pauseButton').style.display = 'flex';
                    document.getElementById('returnToMenuButton').style.display = 'flex';
                    
                    if (auth.isLoggedIn) {
                        document.getElementById('userMenu').style.display = 'block';
                        document.getElementById('menuButtonInGame').style.display = 'none';
                        document.getElementById('userAccountMenu').style.display = 'none';
                    } else {
                        document.getElementById('userMenu').style.display = 'none';
                        document.getElementById('menuButtonInGame').style.display = 'flex';
                        document.getElementById('userAccountMenu').style.display = 'none';
                    }
                    
                    applyAllSettings();
                    updateLanguageTexts();
                    
                    // Debug: Log s·ªë c√¢u h·ªèi th·ª±c t·∫ø
                    console.log(`üéØ Game th·ª±c t·∫ø c√≥ ${game.originalQuestions.length} c√¢u h·ªèi`);
                    console.log('üìù C√¢u h·ªèi th·ª±c t·∫ø ƒë·∫ßu ti√™n:', game.originalQuestions[0]);
                    
                }, 500);
                
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o game:', error);
                loadingEl.remove();
                
                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói th√¢n thi·ªán
                const errorMsg = t.language === 'vi' 
                    ? 'C√≥ l·ªói x·∫£y ra khi t·∫°o c√¢u h·ªèi. S·∫Ω d√πng c√¢u h·ªèi m·∫∑c ƒë·ªãnh.'
                    : 'Error generating questions. Using default questions.';
                
                const effectArea = document.getElementById('effect-area');
                if (effectArea) {
                    const e = document.createElement('div');
                    e.textContent = errorMsg;
                    e.className = 'score-plus-effect';
                    e.style.left = '50%';
                    e.style.top = '50%';
                    e.style.color = '#f5576c';
                    e.style.fontSize = '1.5rem';
                    effectArea.appendChild(e);
                    setTimeout(() => e.remove(), 3000);
                }
                
                // D√πng c√¢u h·ªèi m·∫∑c ƒë·ªãnh nh∆∞ fallback
                if (game) {
                    const defaultQuestions = getDefaultQuestions(selectedGrade, selectedSubject);
                    game.originalQuestions = defaultQuestions;
                    game.remainingQuestions = [...defaultQuestions];
                    game.reset();
                    
                    // V·∫´n b·∫Øt ƒë·∫ßu game v·ªõi c√¢u h·ªèi m·∫∑c ƒë·ªãnh
                    document.getElementById('mainMenu').style.display = 'none';
                    document.getElementById('jumpButton').style.display = 'flex';
                    document.getElementById('pauseButton').style.display = 'flex';
                    document.getElementById('returnToMenuButton').style.display = 'flex';
                    
                    if (auth.isLoggedIn) {
                        document.getElementById('userMenu').style.display = 'block';
                        document.getElementById('menuButtonInGame').style.display = 'none';
                        document.getElementById('userAccountMenu').style.display = 'none';
                    } else {
                        document.getElementById('userMenu').style.display = 'none';
                        document.getElementById('menuButtonInGame').style.display = 'flex';
                        document.getElementById('userAccountMenu').style.display = 'none';
                    }
                }
            }
        }
        
        function returnToMenu() {
            document.getElementById('mainMenu').style.display = 'flex';
            document.getElementById('jumpButton').style.display = 'none';
            document.getElementById('pauseButton').style.display = 'none';
            document.getElementById('returnToMenuButton').style.display = 'none';
            
            if (auth.isLoggedIn) {
                document.getElementById('userMenu').style.display = 'none';
                document.getElementById('menuButtonInGame').style.display = 'none';
                document.getElementById('userAccountMenu').style.display = 'block';
            } else {
                document.getElementById('userMenu').style.display = 'none';
                document.getElementById('menuButtonInGame').style.display = 'none';
                document.getElementById('userAccountMenu').style.display = 'none';
            }
            
            if (game) {
                game.reset();
                gameState = 'ready';
                isPaused = false;
            }
        }

        function returnToMenuFromGame() {
            const t = texts[settings.language];
            if (confirm(t.language === 'vi' ? 'B·∫°n c√≥ ch·∫Øc mu·ªën quay v·ªÅ menu? Ti·∫øn tr√¨nh hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.' : 'Are you sure you want to return to menu? Current progress will be lost.')) {
                returnToMenu();
            }
        }

        function togglePause() {
            if (gameState === 'play' || gameState === 'ready' || gameState === 'over') {
                isPaused = !isPaused;
                const pauseBtn = document.getElementById('pauseButton');
                if (isPaused) {
                    pauseBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                        </svg>
                    `;
                    pauseBtn.classList.remove('bg-yellow-500');
                    pauseBtn.classList.add('bg-green-500');
                    game.showPauseOverlay();
                } else {
                    pauseBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd" />
                        </svg>
                    `;
                    pauseBtn.classList.remove('bg-green-500');
                    pauseBtn.classList.add('bg-yellow-500');
                    game.hidePauseOverlay();
                }
            }
        }

        function showWinModal() {
            const t = texts[settings.language];
            document.getElementById('winTitle').textContent = t.winTitle;
            document.getElementById('winMessage').innerHTML = t.winMessage + '<span id="winGrade">' + selectedGrade + '</span>!';
            document.getElementById('winScoreLabel').textContent = t.winScore;
            document.getElementById('winQuestionsLabel').textContent = t.winQuestions;
            document.getElementById('winBestLabel').textContent = t.winBest;
            document.getElementById('homeText').textContent = t.home;
            document.getElementById('playAgainText').textContent = t.playAgain;
            
            document.getElementById('winScore').textContent = game.score;
            document.getElementById('winAnswered').textContent = game.answeredQuestionsCount || 0;
            document.getElementById('winTotal').textContent = game.originalQuestions.length;
            document.getElementById('winBest').textContent = game.bestScore;
            
            createConfetti();
            
            document.getElementById('winModal').style.display = 'flex';
        }

        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#FFA726', '#42A5F5'];
            const winModal = document.getElementById('winModal');
            
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${5 + Math.random() * 10}px`;
                confetti.style.height = `${10 + Math.random() * 15}px`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                winModal.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function returnToMenuFromWin() {
            document.getElementById('winModal').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            document.getElementById('jumpButton').style.display = 'none';
            document.getElementById('menuButtonInGame').style.display = 'none';
            document.getElementById('pauseButton').style.display = 'none';
            document.getElementById('returnToMenuButton').style.display = 'none';
            
            if (auth.isLoggedIn) {
                document.getElementById('userAccountMenu').style.display = 'block';
            }
        }

        function playAgainFromWin() {
            document.getElementById('winModal').style.display = 'none';
            startGame();
        }

        // ========== B·ªò C√ÇU H·ªéI M·∫∂C ƒê·ªäNH ==========
        const QUESTIONS_GRADE_10 = [
            { subject: "To√°n H·ªçc", text: "T·∫≠p x√°c ƒë·ªãnh c·ªßa h√†m s·ªë y = ‚àö(x-2) l√† g√¨?", options: ["A. [2; +‚àû)", "B. (-‚àû; 2]", "C. ‚Ñù", "D. (2; +‚àû)"], answer: "A" },
            { subject: "To√°n H·ªçc", text: "Nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh 2x - 3 = 5 l√†:", options: ["A. x = 4", "B. x = -4", "C. x = 2", "D. x = -2"], answer: "A" },
            { subject: "V·∫≠t L√Ω", text: "ƒê∆°n v·ªã c·ªßa l·ª±c trong h·ªá SI l√†:", options: ["A. Newton", "B. Joule", "C. Watt", "D. Pascal"], answer: "A" },
            { subject: "H√≥a H·ªçc", text: "C√¥ng th·ª©c h√≥a h·ªçc c·ªßa n∆∞·ªõc l√†:", options: ["A. H‚ÇÇO", "B. CO‚ÇÇ", "C. O‚ÇÇ", "D. H‚ÇÇ"], answer: "A" },
            { subject: "Sinh H·ªçc", text: "ƒê∆°n v·ªã c·∫•u tr√∫c c∆° b·∫£n c·ªßa c∆° th·ªÉ s·ªëng l√†:", options: ["A. T·∫ø b√†o", "B. M√¥", "C. C∆° quan", "D. H·ªá c∆° quan"], answer: "A" }
        ];

        const QUESTIONS_GRADE_11 = [
            { subject: "To√°n H·ªçc", text: "T·∫≠p x√°c ƒë·ªãnh c·ªßa h√†m s·ªë y = tanx l√†:", options: ["A. ‚Ñù\\{œÄ/2 + kœÄ}", "B. ‚Ñù", "C. ‚Ñù\\{kœÄ}", "D. ‚Ñù\\{œÄ + kœÄ}"], answer: "A" },
            { subject: "V·∫≠t L√Ω", text: "ƒê·ªãnh lu·∫≠t Coulomb n√≥i v·ªÅ:", options: ["A. L·ª±c t∆∞∆°ng t√°c ƒëi·ªán t√≠ch", "B. L·ª±c h·∫•p d·∫´n", "C. L·ª±c ƒë√†n h·ªìi", "D. L·ª±c ma s√°t"], answer: "A" },
            { subject: "H√≥a H·ªçc", text: "Ankan c√≥ c√¥ng th·ª©c chung:", options: ["A. C‚ÇôH‚ÇÇ‚Çô‚Çä‚ÇÇ", "B. C‚ÇôH‚ÇÇ‚Çô", "C. C‚ÇôH‚ÇÇ‚Çô‚Çã‚ÇÇ", "D. C‚ÇôH‚ÇÇ‚Çô‚Çã‚ÇÜ"], answer: "A" }
        ];

        const QUESTIONS_GRADE_12 = [
            { subject: "To√°n H·ªçc", text: "Nguy√™n h√†m c·ªßa f(x) = x¬≤ l√†:", options: ["A. x¬≥/3 + C", "B. x¬≥ + C", "C. 2x + C", "D. x¬≤/2 + C"], answer: "A" },
            { subject: "V·∫≠t L√Ω", text: "Hi·ªán t∆∞·ª£ng quang ƒëi·ªán ƒë∆∞·ª£c gi·∫£i th√≠ch b·ªüi:", options: ["A. Thuy·∫øt l∆∞·ª£ng t·ª≠ √°nh s√°ng", "B. Thuy·∫øt s√≥ng √°nh s√°ng", "C. Thuy·∫øt ƒëi·ªán t·ª´", "D. Thuy·∫øt h·∫°t"], answer: "A" }
        ];

        // H√†m l·∫•y c√¢u h·ªèi m·∫∑c ƒë·ªãnh
        function getDefaultQuestions(grade, subject = 'all') {
            if (grade >= 10 && grade <= 12) {
                if (grade === 10) return QUESTIONS_GRADE_10;
                if (grade === 11) return QUESTIONS_GRADE_11;
                if (grade === 12) return QUESTIONS_GRADE_12;
            }
            
            // T·∫°o c√¢u h·ªèi ƒë∆°n gi·∫£n cho l·ªõp 6-9
            const basicQuestions = [
                { subject: "To√°n H·ªçc", text: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh 15 + 27 l√†:", options: ["A. 42", "B. 32", "C. 52", "D. 37"], answer: "A" },
                { subject: "To√°n H·ªçc", text: "S·ªë n√†o chia h·∫øt cho 3?", options: ["A. 21", "B. 22", "C. 23", "D. 25"], answer: "A" },
                { subject: "Ti·∫øng Vi·ªát", text: "T·ª´ n√†o l√† t·ª´ l√°y?", options: ["A. xinh x·∫Øn", "B. hoa h·ªìng", "C. nh√† c·ª≠a", "D. s√°ch v·ªü"], answer: "A" },
                { subject: "Khoa H·ªçc", text: "C√¢y xanh quang h·ª£p nh·ªù ch·∫•t n√†o?", options: ["A. Di·ªáp l·ª•c", "B. Tinh b·ªôt", "C. N∆∞·ªõc", "D. Kh√≠ oxy"], answer: "A" },
                { subject: "L·ªãch S·ª≠", text: "V·ªã vua ƒë·∫ßu ti√™n c·ªßa n∆∞·ªõc VƒÉn Lang l√†:", options: ["A. H√πng V∆∞∆°ng", "B. An D∆∞∆°ng V∆∞∆°ng", "C. L√Ω Nam ƒê·∫ø", "D. ƒêinh B·ªô Lƒ©nh"], answer: "A" }
            ];
            
            return basicQuestions;
        }

        // KH·ªûI T·∫†O BI·∫æN TO√ÄN C·ª§C
        let availableQuestions = [...QUESTIONS_GRADE_10];

        function updateQuestionsByGrade(grade) {
            availableQuestions = getDefaultQuestions(grade);
            
            if (game) {
                game.reset();
            }
        }

        // ========== GAME ENGINE ==========
        const ASSET_PATHS = {
            background: '/bg.png',
            ground: '/base.png',
            pipe: '/pipe-green.png',
            birdDown: '/bluebird-downflap.png',
            birdMid: '/bluebird-midflap.png',
            birdUp: '/bluebird-upflap.png',
            sfxWing: '/sfx_wing.wav',
            sfxPoint: '/sfx_point.wav', 
            sfxHit: '/sfx_hit.wav',
            sfxDie: '/sfx_die.wav',
            sfxSwoosh: '/sfx_swooshing.wav', 
        };


        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const JUMP_VELOCITY_BASE = -4, GRAVITY = 0.2;
        let BASE_SPEED = 1.2;
        const PIPE_WIDTH = 52, BASE_HEIGHT = 112;
        let PIPE_GAP = 130;

        let gameState = 'ready', game, assets = {};

        function loadAssets(cb) {
            let loaded = 0, total = Object.keys(ASSET_PATHS).length;
            for (let k in ASSET_PATHS) {
                if (k.startsWith('sfx')) {
                    const a = new Audio(ASSET_PATHS[k]);
                    a.oncanplaythrough = () => { assets[k] = a; loaded++; if (loaded === total) cb(); };
                    a.onerror = () => { loaded++; if (loaded === total) cb(); };
                } else {
                    const img = new Image();
                    img.onload = () => { assets[k] = img; loaded++; if (loaded === total) cb(); };
                    img.onerror = () => { loaded++; if (loaded === total) cb(); };
                    img.src = ASSET_PATHS[k];
                }
            }
        }

        function playSound(k) { 
            if (assets[k] && settings.soundEnabled) { 
                assets[k].currentTime = 0; 
                assets[k].volume = settings.volume;
                assets[k].play().catch(e => {}); 
            } 
        }

        class Bird {
            constructor() { 
                this.x = 50; 
                this.y = H / 2 - 12; 
                this.width = 34; 
                this.height = 24; 
                this.velocity = 0; 
                this.frame = 0; 
                this.frameCounter = 0; 
                this.rotation = 0; 
            }
            update(df, grav = 1) {
                if (isPaused) return;
                this.velocity += GRAVITY * grav * df;
                this.y += this.velocity * df;
                this.rotation = Math.min(Math.PI / 4, this.velocity * 0.1);
                this.frameCounter++;
                if (this.frameCounter % 5 === 0) this.frame = (this.frame + 1) % 4;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                ctx.rotate(this.rotation);
                
                const imgs = [assets.birdMid, assets.birdUp, assets.birdMid, assets.birdDown];
                if (imgs[this.frame] && assets.birdMid) {
                    ctx.drawImage(imgs[this.frame], -this.width/2, -this.height/2, this.width, this.height);
                } else {
                    const birdColors = settings.birdColors[settings.currentBirdColor];
                    const gradient = ctx.createLinearGradient(-this.width/2, -this.height/2, this.width, this.height);
                    gradient.addColorStop(0, birdColors[0]);
                    gradient.addColorStop(1, birdColors[1]);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                
                ctx.restore();
            }
            jump() { 
                this.velocity = JUMP_VELOCITY_BASE; 
                playSound('sfxWing'); 
            }
        }

        class Pipe {
            constructor(x, h) { this.x = x; this.height = h; this.passed = false; }
            update(df) { if (!isPaused) this.x -= BASE_SPEED * df * settings.gameSpeed; }
            draw() {
                if (!assets.pipe) return;
                ctx.drawImage(assets.pipe, this.x, 0, PIPE_WIDTH, this.height);
                ctx.save();
                ctx.translate(this.x + PIPE_WIDTH/2, this.height + PIPE_GAP + (H - BASE_HEIGHT - (this.height + PIPE_GAP))/2);
                ctx.scale(1, -1);
                ctx.drawImage(assets.pipe, -PIPE_WIDTH/2, -(H - BASE_HEIGHT - (this.height + PIPE_GAP))/2, PIPE_WIDTH, H - BASE_HEIGHT - (this.height + PIPE_GAP));
                ctx.restore();
            }
        }

        // ========== UPDATED GAME CLASS ==========
        class FlappyGame {
            constructor() { 
                this.reset(); 
                this.bestScore = 0; 
                this.autoContinueTimer = null;
                this.lastUserAnswer = null;
                this.isAnswerShown = false;
                this.showContinueButton = false;
                this.explanationText = null;
            }
            reset() {
                this.bird = new Bird(); 
                this.pipes = []; 
                this.score = 0;
                this.pipeTimer = 0; 
                this.baseX = 0; 
                this.hints = 0;
                this.nextHintScore = 10; 
                this.pipesSinceLastQuestion = 0;
                this.currentQuestion = null; 
                this.originalQuestions = [...availableQuestions];
                this.remainingQuestions = [...availableQuestions];
                this.answeredQuestionsCount = 0;
                this.isLastQuestionAnswered = false;
                this.winDelayTimer = 0;
                gameState = 'ready';
                this.hidePauseOverlay();
                applyDifficulty();
                
                // Reset auto continue timer
                if (this.autoContinueTimer) {
                    clearTimeout(this.autoContinueTimer);
                    this.autoContinueTimer = null;
                }
            }
            start() { gameState = 'play'; }
            update(df) {
                if (isPaused) return;
                this.baseX = (this.baseX - BASE_SPEED * df * settings.gameSpeed) % W;
                
                if (this.isLastQuestionAnswered) {
                    this.winDelayTimer += df;
                    if (this.winDelayTimer >= 60) {
                        this.winGame();
                        this.isLastQuestionAnswered = false;
                        this.winDelayTimer = 0;
                    }
                }
                
                if (gameState === 'play') {
                    this.bird.update(df);
                    this.pipeTimer += BASE_SPEED * df * settings.gameSpeed;
                    if (this.pipeTimer > W * 0.8) { 
                        this.generatePipe(); 
                        this.pipeTimer = 0; 
                    }
                    this.pipes.forEach((p, i) => {
                        p.update(df);
                        if (p.x + PIPE_WIDTH < 0) this.pipes.splice(i, 1);
                        if (!p.passed && this.bird.x > p.x + PIPE_WIDTH/2) {
                            p.passed = true; 
                            this.score++; 
                            playSound('sfxPoint');
                            if (this.score >= this.nextHintScore) { 
                                this.hints++; 
                                this.nextHintScore += 10; 
                                const t = texts[settings.language];
                                this.showEffect(W/2, H/2, t.hint === "Hint" ? "+1 HINT" : "+1 G·ª¢I √ù", "yellow"); 
                            }
                        }
                    });
                    this.checkCollision();
                } else if (gameState === 'over') {
                    this.bird.update(df, 1.5);
                    if (this.bird.y + this.bird.height >= H - BASE_HEIGHT) { 
                        this.bird.y = H - BASE_HEIGHT - this.bird.height; 
                        this.bird.velocity = 0; 
                    }
                }
            }
            generatePipe() {
                const h = Math.floor(Math.random() * (H - BASE_HEIGHT - PIPE_GAP - 100)) + 50;
                this.pipes.push(new Pipe(W, h));
                this.pipesSinceLastQuestion++;
                if (this.pipesSinceLastQuestion >= 5 && Math.random() < 0.5 && this.remainingQuestions.length > 0) {
                    this.showRandomQuestion(); 
                    this.pipesSinceLastQuestion = 0;
                }
            }
            checkCollision() {
                if (this.bird.y < 0 || this.bird.y + this.bird.height > H - BASE_HEIGHT) return this.end();
                for (let p of this.pipes) {
                    if (this.bird.x + this.bird.width > p.x && this.bird.x < p.x + PIPE_WIDTH) {
                        if (this.bird.y < p.height || this.bird.y + this.bird.height > p.height + PIPE_GAP) return this.end();
                    }
                }
            }
            end() { 
                if (gameState !== 'over') { 
                    gameState = 'over'; 
                    playSound('sfxHit'); 
                    if (this.score > this.bestScore) this.bestScore = this.score; 
                    
                    updateGameStats();
                } 
            }
            showRandomQuestion() {
                gameState = 'question';
                const idx = Math.floor(Math.random() * this.remainingQuestions.length);
                const q = this.remainingQuestions.splice(idx, 1)[0];
                
                let correctAnswer = q.answer || 'A';
                if (!['A', 'B', 'C', 'D'].includes(correctAnswer)) {
                    correctAnswer = 'A';
                }
                
                this.currentQuestion = { 
                    ...q, 
                    answer: correctAnswer,
                    optionsStatus: q.options.map(o => ({text: o, disabled: false})), 
                    isAnswered: false 
                };
                this.answeredQuestionsCount++;
                this.renderModal();
            }
            
            renderModal() {
                const q = this.currentQuestion;
                document.getElementById('questionSubject').textContent = q.subject;
                document.getElementById('questionText').textContent = q.text;
                
                // Update question counter
                const currentNum = this.originalQuestions.length - this.remainingQuestions.length;
                document.getElementById('currentQuestionNumber').textContent = currentNum;
                document.getElementById('totalQuestions').textContent = this.originalQuestions.length;
                
                // Update icon based on subject
                this.updateQuestionIcon(q.subject);
                
                const container = document.getElementById('answersContainer');
                const actionContainer = document.getElementById('actionButtonsContainer');
                container.innerHTML = '';
                actionContainer.innerHTML = '';
                
                q.optionsStatus.forEach((opt) => {
                    const btn = document.createElement('button');
                    btn.textContent = opt.text;
                    btn.className = `answer-button w-full text-left py-3 px-4 rounded-lg font-medium bg-gradient-to-r from-indigo-500 to-purple-600 text-white ${opt.disabled ? 'disabled' : ''}`;
                    btn.onclick = () => this.checkAnswer(opt.text.charAt(0));
                    btn.disabled = opt.disabled;
                    container.appendChild(btn);
                });
                
                document.getElementById('hintCountText').textContent = this.hints;
                document.getElementById('questionModal').style.display = 'flex';
                
                this.renderSimpleLatex();
            }
            
            updateQuestionIcon(subject) {
                const icon = document.getElementById('questionIcon');
                const subjectIcons = {
                    'To√°n H·ªçc': '‚ûó',
                    'To√°n': '‚ûó',
                    'V·∫≠t L√Ω': '‚ö°',
                    'L√Ω': '‚ö°',
                    'H√≥a H·ªçc': 'üß™',
                    'H√≥a': 'üß™',
                    'Sinh H·ªçc': 'üß¨',
                    'Sinh': 'üß¨',
                    'Ng·ªØ VƒÉn': 'üìù',
                    'VƒÉn': 'üìù',
                    'Ti·∫øng Anh': 'üî§',
                    'Anh': 'üî§',
                    'L·ªãch S·ª≠': 'üèõÔ∏è',
                    'S·ª≠': 'üèõÔ∏è',
                    'ƒê·ªãa L√Ω': 'üåç',
                    'ƒê·ªãa': 'üåç'
                };
                
                icon.textContent = subjectIcons[subject] || '‚ùì';
            }
            
            renderSimpleLatex() {
                // Ch·ªâ x·ª≠ l√Ω c√°c k√Ω hi·ªáu LaTeX c∆° b·∫£n
                const questionEl = document.getElementById('questionText');
                let text = questionEl.textContent;
                
                // Thay th·∫ø m·ªôt s·ªë k√Ω hi·ªáu LaTeX c∆° b·∫£n
                text = text.replace(/\\sqrt\{([^}]+)\}/g, '‚àö($1)');
                text = text.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1/$2');
                text = text.replace(/\^\{([^}]+)\}/g, '^$1');
                text = text.replace(/\^(\d+)/g, '^$1');
                text = text.replace(/_\{([^}]+)\}/g, '_$1');
                text = text.replace(/_(\d+)/g, '_$1');
                text = text.replace(/\\pi/g, 'œÄ');
                text = text.replace(/\\infty/g, '‚àû');
                text = text.replace(/\\alpha/g, 'Œ±');
                text = text.replace(/\\beta/g, 'Œ≤');
                text = text.replace(/\\gamma/g, 'Œ≥');
                
                // X√≥a c√°c d·∫•u ngo·∫∑c LaTeX
                text = text.replace(/\\\(/g, '');
                text = text.replace(/\\\)/g, '');
                text = text.replace(/\\\[/g, '');
                text = text.replace(/\\\]/g, '');
                
                questionEl.textContent = text;
                
                // C≈©ng x·ª≠ l√Ω cho c√°c ƒë√°p √°n
                document.querySelectorAll('#answersContainer .answer-button').forEach(btn => {
                    let btnText = btn.textContent;
                    btnText = btnText.replace(/\\sqrt\{([^}]+)\}/g, '‚àö($1)');
                    btnText = btnText.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1/$2');
                    btnText = btnText.replace(/\^\{([^}]+)\}/g, '^$1');
                    btn.textContent = btnText;
                });
            }
            
            useHint() {
                if (this.hints <= 0 || this.currentQuestion.isAnswered) return;
                
                const wrong = this.currentQuestion.optionsStatus.filter(o => o.text.charAt(0) !== this.currentQuestion.answer && !o.disabled);
                
                if (wrong.length >= 2) {
                    for (let i = 0; i < 2; i++) {
                        const randomIndex = Math.floor(Math.random() * wrong.length);
                        wrong[randomIndex].disabled = true;
                        wrong.splice(randomIndex, 1);
                    }
                } else if (wrong.length === 1) {
                    wrong[0].disabled = true;
                }
                
                this.hints--;
                this.renderModal();
                const t = texts[settings.language];
                this.showEffect(W/2, H/2, t.hint === "Hint" ? "-2 WRONG ANSWERS" : "-2 ƒê√ÅP √ÅN SAI", "#fbbf24");
            }
            
            async checkAnswer(key) {
                this.currentQuestion.isAnswered = true;
                this.lastUserAnswer = key;
                
                const correct = key === this.currentQuestion.answer;
                const msg = document.getElementById('feedbackMessage');
                const t = texts[settings.language];
                const actionContainer = document.getElementById('actionButtonsContainer');
                
                // Disable all answer buttons
                document.querySelectorAll('#answersContainer .answer-button').forEach(btn => {
                    btn.disabled = true;
                    const answerKey = btn.textContent.charAt(0);
                    
                    if (answerKey === this.currentQuestion.answer) {
                        // Highlight correct answer
                        btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        btn.innerHTML = `
                            <div class="flex items-center justify-between">
                                <span>${btn.textContent}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        `;
                    } else if (answerKey === key && !correct) {
                        // Highlight wrong answer chosen by user
                        btn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                        btn.innerHTML = `
                            <div class="flex items-center justify-between">
                                <span>${btn.textContent}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        `;
                    } else {
                        // Dim other answers
                        btn.style.opacity = '0.6';
                    }
                });
                
                // Update stats
                if (auth.isLoggedIn) {
                    auth.updateQuestionStats(this.currentQuestion.subject, correct);
                }
                
                if (correct) {
                    msg.textContent = t.correct;
                    msg.className = "mt-2 text-center text-green-600 font-bold text-lg";
                    this.score += 5;
                    this.pipes.splice(0, 2);
                    
                    // Show success effect
                    this.showEffect(W/2, H/2, "+5 ƒêI·ªÇM", "#10b981");
                    
                    // Hi·ªÉn th·ªã l·ªùi khen khi tr·∫£ l·ªùi ƒë√∫ng - ƒê√É S·ª¨A: HI·ªÜN L√ÇU H∆†N
                    showPraiseNotification();
                } else {
                    msg.textContent = t.wrong;
                    msg.className = "mt-2 text-center text-red-600 font-bold text-lg";
                }
                
                // Render action buttons
                this.renderActionButtons(correct);
                
                // Auto continue if enabled
                if (settings.autoContinue) {
                    this.startAutoContinueTimer();
                }
            }
            
            renderActionButtons(isCorrect) {
                const actionContainer = document.getElementById('actionButtonsContainer');
                const t = texts[settings.language];
                
                actionContainer.innerHTML = '';
                
                // N·∫øu tr·∫£ l·ªùi SAI, ch·ªâ hi·ªÉn th·ªã n√∫t "V·ªÅ menu"
                if (!isCorrect) {
                    const returnButton = document.createElement('button');
                    returnButton.className = 'continue-button';
                    returnButton.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    returnButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M9.53 2.47a.75.75 0 010 1.06L4.81 8.25H15a6.75 6.75 0 010 13.5h-3a.75.75 0 010-1.5h3a5.25 5.25 0 100-10.5H4.81l4.72 4.72a.75.75 0 11-1.06 1.06l-6-6a.75.75 0 010-1.06l6-6a.75.75 0 011.06 0z" clip-rule="evenodd" />
                        </svg>
                        <span>V·ªÄ MENU</span>
                    `;
                    returnButton.onclick = () => {
                        document.getElementById('questionModal').style.display = 'none';
                        returnToMenu();
                    };
                    actionContainer.appendChild(returnButton);
                } 
                // N·∫øu tr·∫£ l·ªùi ƒê√öNG, hi·ªÉn th·ªã n√∫t "Ti·∫øp t·ª•c game"
                else {
                    const continueButton = document.createElement('button');
                    continueButton.className = 'continue-button';
                    continueButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                        </svg>
                        <span>${t.continueGame}</span>
                    `;
                    continueButton.onclick = () => this.continueGame();
                    actionContainer.appendChild(continueButton);
                }
                
                // Explanation button (only if explanations are enabled and user answered)
                if (settings.showExplanations && !isCorrect) {
                    const explainButton = document.createElement('button');
                    explainButton.className = 'explanation-button-small';
                    explainButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842a3.75 3.75 0 01-.837.552c-.676.328-1.028.774-1.028 1.152v.75a.75.75 0 01-1.5 0v-.75c0-1.279 1.06-2.107 1.875-2.502.182-.088.351-.199.503-.331.83-.727.83-1.857 0-2.584zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                        </svg>
                        <span>${t.showExplanation}</span>
                    `;
                    explainButton.onclick = () => this.getExplanation();
                    actionContainer.appendChild(explainButton);
                }
            }
            
            startAutoContinueTimer() {
                if (this.autoContinueTimer) clearTimeout(this.autoContinueTimer);
                
                // Show countdown
                let countdown = 3;
                const indicator = document.getElementById('autoContinueIndicator');
                if (indicator) {
                    indicator.style.display = 'flex';
                    const updateCountdown = () => {
                        if (countdown > 0) {
                            indicator.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                                </svg>
                                <span>T·ª± ƒë·ªông ti·∫øp t·ª•c trong ${countdown}s...</span>
                            `;
                            countdown--;
                            setTimeout(updateCountdown, 1000);
                        } else {
                            indicator.style.display = 'none';
                            this.continueGame();
                        }
                    };
                    updateCountdown();
                }
                
                // Set auto continue timeout
                this.autoContinueTimer = setTimeout(() => {
                    this.continueGame();
                }, 3000);
            }
            
            async getExplanation() {
                if (!this.currentQuestion) return;
                
                // Show loading
                document.getElementById('explanationLoading').style.display = 'block';
                document.getElementById('explanationContent').style.display = 'none';
                document.getElementById('explanationModal').style.display = 'flex';
                
                // Set question info
                document.getElementById('explanationQuestion').textContent = this.currentQuestion.text;
                document.getElementById('explanationCorrectAnswer').textContent = 
                    this.currentQuestion.options.find(opt => opt.charAt(0) === this.currentQuestion.answer);
                
                if (this.lastUserAnswer && this.lastUserAnswer !== this.currentQuestion.answer) {
                    document.getElementById('explanationUserAnswer').textContent = 
                        this.currentQuestion.options.find(opt => opt.charAt(0) === this.lastUserAnswer);
                    document.getElementById('explanationUserAnswerContainer').style.display = 'flex';
                } else {
                    document.getElementById('explanationUserAnswerContainer').style.display = 'none';
                }
                
                try {
                    console.log('ü§ñ ƒêang l·∫•y gi·∫£i th√≠ch t·ª´ AI...');
                    
                    const response = await fetch(`${BACKEND_CONFIG.url}/api/explain-answer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            question: this.currentQuestion,
                            answer: this.currentQuestion.answer,
                            userAnswer: this.lastUserAnswer
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to get explanation');
                    
                    const data = await response.json();
                    if (data.success && data.explanation) {
                        document.getElementById('explanationText').textContent = data.explanation;
                    } else {
                        throw new Error('No explanation received');
                    }
                    
                } catch (error) {
                    console.error('‚ùå L·ªói khi l·∫•y gi·∫£i th√≠ch:', error);
                    // Fallback explanation
                    document.getElementById('explanationText').textContent = 
                        "Gi·∫£i th√≠ch kh√¥ng kh·∫£ d·ª•ng. ƒê√°p √°n ƒë√∫ng l√† " + 
                        this.currentQuestion.answer + " v√¨ n√≥ ph√π h·ª£p v·ªõi ki·∫øn th·ª©c ƒë√£ h·ªçc.";
                }
                
                // Hide loading, show content
                document.getElementById('explanationLoading').style.display = 'none';
                document.getElementById('explanationContent').style.display = 'block';
                
                // Ch·ªâ hi·ªÉn th·ªã n√∫t "ƒê√≥ng" khi tr·∫£ l·ªùi sai
                document.querySelector('.explanation-buttons').innerHTML = `
                    <button onclick="game.closeExplanation()" class="explanation-button close">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                        <span id="closeExplanationText">ƒê√≥ng</span>
                    </button>
                `;
            }
            
            continueGame() {
                // Clear auto continue timer
                if (this.autoContinueTimer) {
                    clearTimeout(this.autoContinueTimer);
                    this.autoContinueTimer = null;
                }
                
                // Hide auto continue indicator
                const indicator = document.getElementById('autoContinueIndicator');
                if (indicator) indicator.style.display = 'none';
                
                // Close modals
                document.getElementById('questionModal').style.display = 'none';
                document.getElementById('explanationModal').style.display = 'none';
                
                // Reset state
                this.isAnswerShown = false;
                this.showContinueButton = false;
                this.explanationText = null;
                
                // Continue game
                gameState = 'play';
                
                // Check if this was the last question
                if (this.remainingQuestions.length === 0) {
                    this.isLastQuestionAnswered = true;
                    this.winDelayTimer = 0;
                    this.showEffect(W/2, H/2, "HO√ÄN TH√ÄNH T·∫§T C·∫¢ C√ÇU H·ªéI!", "#FFD700");
                }
            }
            
            closeExplanation() {
                document.getElementById('explanationModal').style.display = 'none';
                // Khi ƒë√≥ng gi·∫£i th√≠ch (ch·ªâ x·∫£y ra khi tr·∫£ l·ªùi sai), v·ªÅ menu
                returnToMenu();
            }
            
            winGame() {
                gameState = 'win';
                this.bird.velocity = 0;
                showWinModal();
            }
            
            showEffect(x, y, txt, col) {
                const e = document.createElement('div'); 
                e.textContent = txt; 
                e.className = 'score-plus-effect';
                e.style.left = x + 'px'; 
                e.style.top = y + 'px'; 
                e.style.color = col;
                document.getElementById('effect-area').appendChild(e);
                setTimeout(() => e.remove(), 1500);
            }
            
            showPauseOverlay() {
                const overlay = document.createElement('div');
                overlay.className = 'pause-overlay';
                overlay.id = 'pauseOverlay';
                
                const text = document.createElement('div');
                text.className = 'pause-text';
                const t = texts[settings.language];
                text.textContent = t.pause;
                overlay.appendChild(text);
                
                const continueButton = document.createElement('button');
                continueButton.className = 'pause-button';
                continueButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                    </svg>
                    ${t.continue}
                `;
                continueButton.onclick = togglePause;
                overlay.appendChild(continueButton);
                
                canvas.parentElement.appendChild(overlay);
            }
            
            hidePauseOverlay() {
                const overlay = document.getElementById('pauseOverlay');
                if (overlay) overlay.remove();
            }
            
            draw() {
                if (assets.background && assets.background.complete) {
                    ctx.drawImage(assets.background, 0, 0, W, H);
                } else {
                    const bgColors = settings.bgColors[settings.currentBgColor];
                    const gradient = ctx.createLinearGradient(0, 0, W, H);
                    gradient.addColorStop(0, bgColors[0]);
                    gradient.addColorStop(1, bgColors[1]);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, W, H);
                }
                
                this.pipes.forEach(p => p.draw());
                
                if (assets.ground && assets.ground.complete) {
                    for (let x = this.baseX; x < W + assets.ground.width; x += assets.ground.width) {
                        ctx.drawImage(assets.ground, x, H - BASE_HEIGHT, assets.ground.width, BASE_HEIGHT);
                    }
                }
                
                this.bird.draw();
                
                ctx.fillStyle = 'white'; 
                ctx.font = '30px Inter'; 
                ctx.textAlign = 'center';
                ctx.fillText(this.score, W/2, 50);
                
                const t = texts[settings.language];
                
                if (gameState === 'ready') { 
                    ctx.fillText(t.tapToFly, W/2, H/2); 
                }
                if (gameState === 'over') {
                    ctx.fillStyle = 'rgba(0,0,0,0.7)'; 
                    ctx.fillRect(0,0,W,H);
                    ctx.fillStyle = 'white'; 
                    ctx.fillText(t.gameOver, W/2, H/2 - 60);
                    ctx.font = '20px Inter'; 
                    ctx.fillText(`${t.score}: ${this.score}`, W/2, H/2 - 20);
                    ctx.fillText(`${t.best}: ${this.bestScore}`, W/2, H/2 + 10);
                    
                    // Ch·ªâ hi·ªÉn th·ªã 1 l·ª±a ch·ªçn: Quay v·ªÅ Menu
                    ctx.font = '18px Inter';
                    ctx.fillText(t.returnToMenu, W/2, H/2 + 60);
                    
                    // V·∫Ω n√∫t Back to Menu ƒë·∫πp h∆°n
                    ctx.fillStyle = 'rgba(139, 92, 246, 0.8)'; // M√†u t√≠m
                    ctx.fillRect(W/2 - 100, H/2 + 80, 200, 40);
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Inter';
                    ctx.fillText(t.returnToMenu, W/2, H/2 + 105);
                }
                if (gameState === 'win') {
                    ctx.fillStyle = 'rgba(0,0,0,0.7)'; 
                    ctx.fillRect(0,0,W,H);
                    ctx.fillStyle = '#FFD700'; 
                    ctx.font = 'bold 40px Inter'; 
                    ctx.fillText(t.victory, W/2, H/2 - 30);
                    ctx.font = '20px Inter'; 
                    ctx.fillStyle = 'white';
                    ctx.fillText(`${t.completedQuestions.replace('c√¢u h·ªèi', 'questions')} ${this.originalQuestions.length} ${t.completedQuestions.includes('c√¢u h·ªèi') ? 'c√¢u h·ªèi' : 'questions'}!`, W/2, H/2 + 30);
                }
            }
        }

        function handleJump(e) {
            if (e) e.preventDefault();
            if (isPaused) return;
            if (!settings.touchControl && e.type === 'mousedown') return;
            
            // L·∫•y t·ªça ƒë·ªô click
            let clientX, clientY;
            if (e.type === 'mousedown') {
                clientX = e.clientX;
                clientY = e.clientY;
            } else if (e.type === 'touchstart') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.type === 'keydown' && e.code === 'Space') {
                // X·ª≠ l√Ω ph√≠m Space ri√™ng
                if (gameState === 'ready') game.start();
                if (gameState === 'play') game.bird.jump();
                if (gameState === 'over') returnToMenu();
                return;
            }
            
            // Ki·ªÉm tra click v√†o n√∫t khi game over
            if (gameState === 'over') {
                if (clientX !== undefined && clientY !== undefined) {
                    checkGameOverClick(clientX, clientY);
                } else {
                    returnToMenu(); // Fallback n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c t·ªça ƒë·ªô
                }
                return;
            }
            
            if (gameState === 'ready') game.start();
            if (gameState === 'play') game.bird.jump();
        }

        let lastTime = 0;
        function loop(ts) {
            let df = (ts - (lastTime || ts)) / FPS_STANDARD;
            lastTime = ts;
            if (gameState !== 'question') { 
                ctx.clearRect(0,0,W,H); 
                game.update(df); 
                game.draw(); 
            }
            requestAnimationFrame(loop);
        }

        // ========== TEST BACKEND CONNECTION UI ==========
        async function testBackendConnectionUI() {
            const button = document.querySelector('button[onclick="testBackendConnectionUI()"]');
            const originalText = button.querySelector('span').textContent;
            
            // ƒê·ªïi text button
            button.querySelector('span').textContent = 'üîç ƒêANG KI·ªÇM TRA...';
            button.disabled = true;
            
            // Hi·ªÉn th·ªã loading nh·ªè
            const effectArea = document.getElementById('effect-area');
            let loadingEl;
            if (effectArea) {
                loadingEl = document.createElement('div');
                loadingEl.innerHTML = `
                    <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
                               background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px;
                               text-align: center; min-width: 200px; z-index: 100;">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-3"></div>
                        <div style="color: white; font-size: 0.9rem;">ƒêang ki·ªÉm tra k·∫øt n·ªëi server...</div>
                    </div>
                `;
                effectArea.appendChild(loadingEl);
            }
            
            try {
                const connected = await checkBackendConnection();
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                if (effectArea) {
                    const resultEl = document.createElement('div');
                    resultEl.innerHTML = `
                        <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
                                   background: ${connected ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)'}; 
                                   padding: 20px; border-radius: 15px; text-align: center; min-width: 200px;
                                   z-index: 101; backdrop-filter: blur(10px);">
                            <div style="font-size: 2.5rem; margin-bottom: 10px;">
                                ${connected ? '‚úÖ' : '‚ùå'}
                            </div>
                            <div style="color: white; font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">
                                ${connected ? 'K·∫æT N·ªêI TH√ÄNH C√îNG' : 'KH√îNG TH·ªÇ K·∫æT N·ªêI'}
                            </div>
                            <div style="color: ${connected ? '#d1fae5' : '#fecaca'}; font-size: 0.9rem;">
                                ${BACKEND_CONFIG.url}
                            </div>
                            <div style="color: ${connected ? '#a7f3d0' : '#fca5a5'}; font-size: 0.8rem; margin-top: 10px;">
                                ${connected ? 'AI server s·∫µn s√†ng!' : 'Ki·ªÉm tra l·∫°i backend server'}
                            </div>
                        </div>
                    `;
                    effectArea.appendChild(resultEl);
                    
                    // Auto remove
                    setTimeout(() => {
                        if (resultEl.parentNode) resultEl.parentNode.removeChild(resultEl);
                        if (loadingEl && loadingEl.parentNode) loadingEl.parentNode.removeChild(loadingEl);
                    }, 3000);
                }
                
            } catch (error) {
                console.error('L·ªói ki·ªÉm tra k·∫øt n·ªëi:', error);
            }
            
            // Kh√¥i ph·ª•c button
            setTimeout(() => {
                button.querySelector('span').textContent = originalText;
                button.disabled = false;
            }, 1000);
        }

        // ========== DEBUG FUNCTIONS ==========
        window.debugBackend = async function() {
            console.log('üîß ===== DEBUG BACKEND =====');
            console.log('Backend URL:', BACKEND_CONFIG.url);
            console.log('isBackendAvailable:', isBackendAvailable);
            console.log('backendCheckAttempted:', backendCheckAttempted);
            
            // Test connection
            try {
                const response = await fetch(`${BACKEND_CONFIG.url}/api/health`);
                console.log('Health check status:', response.status);
                const data = await response.json();
                console.log('Health check data:', data);
            } catch (error) {
                console.error('Health check failed:', error.message);
            }
            
            // Test generate questions
            console.log('Testing question generation...');
            const questions = await generateQuestions(10, 'To√°n', 3);
            console.log('Generated questions:', questions);
        };
        
        // Shortcut ƒë·ªÉ test nhanh
        window.testAI = () => debugBackend();

        window.onload = () => {
            loadAssets(() => { 
                game = new FlappyGame(); 
                loop(); 
                loadSettings();
                initAuth();
                setupGradeSubjectSelection(); // THAY ƒê·ªîI: G·ªçi h√†m m·ªõi
                updateLanguageTexts();
                
                // TH√äM D√íNG N√ÄY: Auto check backend khi load game
                setTimeout(() => {
                    console.log('üîç T·ª± ƒë·ªông ki·ªÉm tra k·∫øt n·ªëi backend...');
                    checkBackendConnection().then(connected => {
                        if (connected) {
                            console.log('‚úÖ Backend s·∫µn s√†ng cho game!');
                        } else {
                            console.warn('‚ö†Ô∏è Backend kh√¥ng kh·∫£ d·ª•ng, s·∫Ω d√πng c√¢u h·ªèi m·∫∑c ƒë·ªãnh');
                        }
                    });
                }, 1000);
            });
        };
        
        if (settings.touchControl) {
            canvas.addEventListener('mousedown', handleJump);
            canvas.addEventListener('touchstart', handleJump);
        }
        
        window.addEventListener('keydown', e => { 
            if (e.code === 'Space') handleJump(e);
            if (e.code === 'Escape') togglePause();

        });
                window.addEventListener('keydown', e => { 
            if (e.code === 'Space') handleJump(e);
            if (e.code === 'Escape') togglePause();
        });
        
        // ========== KI·ªÇM TRA CLICK TR√äN M√ÄN H√åNH GAME OVER ==========
        function checkGameOverClick(x, y) {
            if (gameState !== 'over') return false;
            
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const clickX = (x - rect.left) * scaleX;
            const clickY = (y - rect.top) * scaleY;
            
            // Ki·ªÉm tra click v√†o n√∫t "Quay v·ªÅ Menu"
            const buttonX = canvas.width / 2 - 100;
            const buttonY = canvas.height / 2 + 80;
            const buttonWidth = 200;
            const buttonHeight = 40;
            
            if (clickX >= buttonX && clickX <= buttonX + buttonWidth &&
                clickY >= buttonY && clickY <= buttonY + buttonHeight) {
                returnToMenu();
                return true;
            }
            return false;
        }
        
        // ========== BACKEND CONNECTION CHECK ==========
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${BACKEND_CONFIG.url}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    timeout: 5000
                });
                
                const data = await response.json();
                isBackendAvailable = data.success === true;
                backendCheckAttempted = true;
                return isBackendAvailable;
            } catch (error) {
                console.warn('Backend kh√¥ng kh·∫£ d·ª•ng:', error.message);
                isBackendAvailable = false;
                backendCheckAttempted = true;
                return false;
            }
        }
    </script>
</body>
</html>